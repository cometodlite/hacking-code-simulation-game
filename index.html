<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <title>HCSiG - Hacking Code Simulator Game</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #05070b;
      color: #e5e5e5;
      height: var(--app-height, 100vh);
      min-height: 100vh;
      min-height: 100svh;
      min-height: 100dvh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      overflow: hidden;
    }

    header {
      padding: 10px 16px;
      background: #0e1117;
      border-bottom: 1px solid #222;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      position: relative;
      z-index: 60;
    }
.header-left {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    header h1 {
      font-size: 18px;
      letter-spacing: 1px;
    }

    .header-version {
      font-size: 11px;
      opacity: 0.7;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    header span.subtitle {
      font-size: 13px;
      opacity: 0.7;
    }

    #main {
      display: flex;
      height: calc(var(--app-height, 100vh) - 48px);
      width: 100vw;
      overflow: hidden;
    }

    .panel {
      padding: 10px;
      overflow: auto;
      background: #060812;
      border-right: 1px solid #111;
    }

    #leftPanel {
      flex: 0 0 24%;
      overflow: hidden; /* STATUS ê³ ì • + SHOPë§Œ ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Shop ë¦¬ìŠ¤íŠ¸ë§Œ ìŠ¤í¬ë¡¤ */
    #shopList {
      overflow: auto;
      flex: 1 1 auto;
      min-height: 160px;
    }

    #centerPanel {
      flex: 1 1 auto;
    }

    #rightPanel {
      flex: 0 0 26%;
      border-right: none;
      background: #04050a;
    }

    .resizer {
      flex: 0 0 4px;
      background: #111;
      cursor: col-resize;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #8ab4ff;
    }

    .stat-box {
      border: 1px solid #222;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 10px;
      background: #090c16;
      font-size: 13px;
    }

    .resizable-box {
      resize: vertical;
      overflow: auto;
      min-height: 80px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .stat-row:last-child {
      margin-bottom: 0;
    }

    .label {
      opacity: 0.7;
    }

    .value {
      font-weight: 600;
    }

    #energyBarWrapper {
      margin-top: 4px;
      height: 10px;
      background: #151822;
      border-radius: 999px;
      overflow: hidden;
    }

    #energyBarInner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00ffaa, #00d4ff);
      transition: width 0.1s linear;
    }

    #traceBarWrapper {
      margin-top: 4px;
      height: 10px;
      background: #0b1220;
      border: 1px solid #223;
      border-radius: 6px;
      overflow: hidden;
    }
    #traceBarInner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ffcf5c, #ff4b4b);
      transition: width 0.1s linear;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    button {
      background: #111827;
      color: #e5e5e5;
      border: 1px solid #20263b;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s, transform 0.05s;
      white-space: nowrap;
    }

    
    /* v1.6.2: ë”ë³´ê¸° í´ë¦­ ë¶ˆê°€ ë²„ê·¸ ë°©ì§€ (í—¤ë”/ë²„íŠ¼ ë ˆì´ì–´ ìš°ì„ ) */
    #btnMore{ position: relative; z-index: 61; }
button:hover {
      background: #1b2238;
      border-color: #4b7fff;
    }

    button:active {
      transform: scale(0.97);
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
    }

    #logList {
      font-size: 12px;
      line-height: 1.5;
    }

    .log-entry {
      margin-bottom: 4px;
      border-bottom: 1px dashed #151515;
      padding-bottom: 2px;
    }

    .log-time {
      opacity: 0.55;
      margin-right: 6px;
    }

    .log-tag {
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 4px;
      margin-right: 4px;
      text-transform: uppercase;
    }

    .tag-system { background: #124; color: #9cf; }
    .tag-scan   { background: #042; color: #8f8; }
    .tag-hack   { background: #240; color: #df8; }
    .tag-shop   { background: #402; color: #f9c; }
    .tag-level  { background: #440; color: #ffd966; }

    select {
      background: #0b1020;
      border: 1px solid #20263b;
      color: #e5e5e5;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 12px;
      width: 100%;
      margin-bottom: 6px;
    }

    .shop-item {
      border-bottom: 1px solid #111;
      padding: 6px 0;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .shop-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .shop-name {
      font-weight: 600;
    }

    .shop-cost {
      font-size: 11px;
      opacity: 0.8;
    }

    .shop-desc {
      opacity: 0.8;
    }

    .shop-meta {
      font-size: 11px;
      opacity: 0.85;
    }

    .shop-item button {
      align-self: flex-start;
      margin-top: 2px;
    }

    .center-inner {
      position: relative;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .flex-row {
      display: flex;
      gap: 8px;
    }

    .flex-col {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .flex-grow {
      flex: 1 1 auto;
    }

    .small {
      font-size: 11px;
      opacity: 0.8;
    }

    /* ì½”ë“œ ì¸ë²¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ */

    #codeList {
      list-style: none;
      font-size: 12px;
      max-height: 240px;
      overflow: auto;
    }

    #codeList li {
      padding: 4px 6px;
      border-radius: 4px;
      margin-bottom: 2px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      border: 1px solid transparent;
    }

    #codeList li.active {
      background: #1f2937;
      border-color: #4b7fff;
    }

    #codeList li span.meta {
      opacity: 0.7;
      font-size: 11px;
    }

    /* ì½”ë“œ í¬ê·€ë„ ìƒ‰ìƒ */

    .rarity-common {
      color: #9ca3af;
    }
    .rarity-uncommon {
      color: #22c55e;
    }
    .rarity-rare {
      color: #38bdf8;
    }
    .rarity-epic {
      color: #a855f7;
    }
    .rarity-legendary {
      color: #facc15;
    }

    .rarity-tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      margin-left: 4px;
      border: 1px solid transparent;
    }

    .rarity-tag.rarity-common {
      border-color: #4b5563;
      background: #020617;
    }
    .rarity-tag.rarity-uncommon {
      border-color: #14532d;
      background: #022c22;
    }
    .rarity-tag.rarity-rare {
      border-color: #0f766e;
      background: #022c3a;
    }
    .rarity-tag.rarity-epic {
      border-color: #6b21a8;
      background: #1e1030;
    }
    .rarity-tag.rarity-legendary {
      border-color: #854d0e;
      background: #422006;
    }

    /* ì½”ë“œ ìŠ¤ìº” ì—°ì¶œ (ë” í¬ê²Œ) */

    #scanOverlay {
      position: absolute;
      inset: 4px;
      border-radius: 10px;
      background: radial-gradient(circle at top, rgba(56,189,248,0.18), rgba(15,23,42,0.95));
      border: 1px solid #22c55e55;
      box-shadow: 0 0 18px rgba(16,185,129,0.4);
      display: none;
      flex-direction: column;
      padding: 12px;
      font-size: 13px;
      z-index: 10;
    }

    #scanOverlay.active {
      display: flex;
    }

    #scanProgressWrapper {
      height: 10px;
      background: #020617;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 10px;
      border: 1px solid #0f172a;
    }

    #scanProgressInner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      transition: width 0.08s linear;
    }

    #scanText {
      flex: 1;
      overflow: hidden;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      color: #bbf7ff;
      font-size: 13px;
      line-height: 1.3;
    }

    /* ë¡œê·¸ í•„í„° */

    .log-filter-label {
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 2px;
      margin-right: 6px;
      opacity: 0.8;
    }

    .log-filter-label input {
      transform: scale(0.9);
    }

    /* ë”ë³´ê¸° ëª¨ë‹¬ + íƒ­ */

    #moreModalBackdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      z-index: 40;
      align-items: center;
      justify-content: center;
    }

    #moreModalBackdrop.active {
      display: flex;
    }

    #moreModal {
      width: 780px;
      max-width: 95vw;
      max-height: 85vh;
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.75);
      display: flex;
      flex-direction: column;
    }

    #moreModalHeader {
      padding: 10px 12px;
      border-bottom: 1px solid #111827;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    #moreModalHeader h2 {
      font-size: 14px;
    }

    #moreModalBody {
      padding: 8px 12px 10px;
      overflow: auto;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #moreModalFooter {
      padding: 8px 12px;
      border-top: 1px solid #111827;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      background: #1f2937;
      color: #cbd5f5;
      margin-right: 4px;
    }

    .update-log {
      border: 1px solid #0f172a;
      border-radius: 6px;
      padding: 8px;
      background: #020617;
    }

    .update-log ul {
      margin-left: 18px;
      margin-top: 4px;
    }

    .update-log li {
      margin-bottom: 3px;
    }

    .mission-item, .achievement-item {
      border-bottom: 1px solid #111827;
      padding: 4px 0;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
    }

    .mission-main, .achievement-main {
      flex: 1 1 auto;
    }

    .mission-progress {
      font-size: 11px;
      opacity: 0.8;
    }

    .tag-complete {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #14532d;
      color: #bbf7d0;
    }

    .tag-incomplete {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #4b5563;
      color: #e5e7eb;
    }

    .mission-reward {
      font-size: 11px;
      opacity: 0.9;
    }

    .more-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
      border-bottom: 1px solid #111827;
      padding-bottom: 4px;
    }

    .more-tab-button {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 6px 6px 0 0;
      border: 1px solid transparent;
      border-bottom: none;
      background: transparent;
      cursor: pointer;
      opacity: 0.75;
    }

    .more-tab-button.active {
      background: #020617;
      border-color: #1f2937;
      border-bottom-color: #020617;
      opacity: 1;
    }

    .more-tab-panel {
      display: none;
    }

    .more-tab-panel.active {
      display: block;
    }

    .diff-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      margin-left: 4px;
    }

    .diff-easy {
      background: #14532d;
      color: #bbf7d0;
    }

    .diff-normal {
      background: #1d4ed8;
      color: #bfdbfe;
    }

    .diff-hard {
      background: #7f1d1d;
      color: #fecaca;
    }

    /* ë¯¸ì…˜ íƒ­ ë²„íŠ¼ */

    .mission-scope-tabs {
      display: flex;
      gap: 6px;
      margin: 4px 0 6px;
    }

    .mission-scope-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border-width: 1px;
      opacity: 0.75;
    }

    .mission-scope-btn.active {
      opacity: 1;
      border-color: #4b7fff;
      background: #111827;
    }

    /* ìƒì  í¬ê·€ë„ ìƒ‰ */

    .shop-rarity-pill {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid transparent;
      margin-right: 4px;
    }

    .shop-rarity-common {
      color: #e5e7eb;
      border-color: #4b5563;
      background: #020617;
    }
    .shop-rarity-uncommon {
      color: #bbf7d0;
      border-color: #15803d;
      background: #022c22;
    }
    .shop-rarity-rare {
      color: #bae6fd;
      border-color: #0e7490;
      background: #022c3a;
    }
    .shop-rarity-epic {
      color: #e9d5ff;
      border-color: #7c2d12;
      background: #1e1030;
    }
    .shop-rarity-legendary {
      color: #fef3c7;
      border-color: #fbbf24;
      background: #422006;
    }

    /* ìƒì  ì •ë ¬ UI */
    .shop-sort-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin: 6px 0 8px;
      opacity: 0.95;
    }
    .shop-sort-label{
      font-size: 12px;
      opacity: 0.75;
    }
    #shopSortSelect{
      background:#0b1220;
      border:1px solid #263042;
      color:#e5e7eb;
      border-radius:10px;
      padding:6px 10px;
      font-size: 12px;
      outline: none;
    }
    #shopSortSelect:focus{
      border-color:#4b7fff;
      box-shadow: 0 0 0 2px rgba(75,127,255,0.18);
    }

    /* ìƒì  ì¹´í…Œê³ ë¦¬ í‘œê¸° */
    .shop-cat-pill{
      display:inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #243145;
      background: #0b1220;
      color: #cbd5e1;
      margin-right: 6px;
      opacity: 0.95;
    }

    /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
    #toastContainer{
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 9999;
      pointer-events: none;
      width: min(520px, calc(100vw - 24px));
    }
    .toast{
      display:flex;
      align-items:center;
      gap: 10px;
      background: #0e1117;
      border: 1px solid #243145;
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.45);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity: 1;
      transform: translateY(0);
    }
    .toast .tag{
      font-size: 11px;
      border: 1px solid #334155;
      background:#0b1220;
      color:#e5e7eb;
      padding: 2px 8px;
      border-radius: 999px;
      opacity: 0.95;
      white-space: nowrap;
    }
    .toast .msg{
      font-size: 13px;
      line-height: 1.2;
      opacity: 0.95;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }


    :root{
      --ui-zoom: 1;
      --font-scale: 1;
    }
    html{
      font-size: calc(16px * var(--font-scale));
      height: 100%;
    }
    #main, #moreModal{
      zoom: var(--ui-zoom);
    }
    body.no-anim *{
      transition: none !important;
      animation: none !important;
    }
    .log-entry.pinned{
      outline: 1px solid #2c4f7a;
      background: rgba(20,34,60,0.5);
    }

  

/* shop limit badge + disabled */
.shop-limit-badge{
  font-size: 12px;
}
.shop-buy:disabled{
  opacity: 0.45;
  cursor: not-allowed;
}



/* =========================
   MOBILE: FILL VIEWPORT (no empty gap feel)
   ========================= */
@media (max-width: 900px), (hover: none) and (pointer: coarse) {
  html, body { height: 100%; }
  body { min-height: 100dvh; display: flex; flex-direction: column; }
  header { flex: 0 0 auto; }
  #main { flex: 1 1 auto; min-height: 0; }

  /* Each mobile view should be a full-height column */
  .mobile-view { height: 100%; min-height: 0; display: flex; flex-direction: column; }

  /* Make the primary content card grow to fill remaining space */
  .mobile-view .stat-box,
  .mobile-view .panel,
  .mobile-view .log-list,
  .mobile-view .shop-list,
  .mobile-view .codes-wrap,
  .mobile-view .actions-wrap {
    flex: 1 1 auto;
    min-height: 0;
  }

  /* Keep lists scrollable inside full-height views */
  .mobile-view .log-list,
  .mobile-view .shop-list,
  .mobile-view .code-list {
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
}
@media (max-width: 900px), (hover: none) and (pointer: coarse) {
  #main, .main { position: relative; }
  .mobile-tabs {
    position: fixed;
    left: 10px; right: 10px; bottom: 10px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    padding: 8px;
    border-radius: 14px;
    background: rgba(14,17,23,0.92);
    border: 1px solid rgba(35,42,53,0.9);
    backdrop-filter: blur(10px);
    z-index: 9999;
  }
  .mobile-tabs button{
    width: 100%;
    min-height: 44px;
    font-size: 13px;
    font-weight: 700;
    border-radius: 12px;
  }
  .mobile-tabs button.active{
    outline: 2px solid rgba(148,163,184,0.7);
  }

  body.mobile-tab-left #leftPanel,
  body.mobile-tab-center #centerPanel,
  body.mobile-tab-right #rightPanel { display: block !important; }

  body.mobile-tab-left #centerPanel,
  body.mobile-tab-left #rightPanel,
  body.mobile-tab-center #leftPanel,
  body.mobile-tab-center #rightPanel,
  body.mobile-tab-right #leftPanel,
  body.mobile-tab-right #centerPanel { display: none !important; }

  #leftPanel, #centerPanel, #rightPanel {
    height: calc(100dvh - 52px - 84px) !important;
    max-height: calc(100dvh - 52px - 84px) !important;
    overflow: auto !important;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 100px !important;
  }

  button { min-height: 44px !important; }
  input, select, textarea { min-height: 44px !important; font-size: 16px !important; }
}

    /* =========================
       Christmas Theme (optional)
       ========================= */
    .xmas-accent { color: #7dd3fc; }
    #snowLayer{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }
    .snowflake{
      position: absolute;
      top: -12px;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      opacity: 0.75;
      filter: blur(0.2px);
      animation: snowFall linear infinite;
    }
    @keyframes snowFall{
      0%{ transform: translateY(-20px); }
      100%{ transform: translateY(calc(var(--app-height, 100vh) + 40px)); }
    }

    /* =========================
       Mailbox
       ========================= */
    .mail-topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; margin:8px 0 10px;
    }
    .mail-count{
      font-size:12px; opacity:.85;
    }
    .mail-item{
      border: 1px solid #1f2a3d;
      background: #0b1220;
      border-radius: 10px;
      padding: 10px 10px;
      margin-bottom: 8px;
    }
    .mail-title{
      font-weight: 700;
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      margin-bottom: 4px;
    }
    .mail-meta{
      font-size: 12px;
      opacity: .78;
      margin-bottom: 6px;
    }
    .mail-body{
      font-size: 13px;
      line-height: 1.35;
      opacity: .92;
      white-space: pre-wrap;
    }
    .mail-reward{
      margin-top: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 12px;
      opacity: .95;
    }
    .mail-claimed{
      opacity: .55;
      filter: grayscale(0.2);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 2px 8px;
      border: 1px solid #263247;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.6);
      font-size: 12px;
      opacity: 0.9;
    }

</style>
</head>
<body>
  <div id="snowLayer" aria-hidden="true"></div>
  <header>
    <div class="header-left">
      <h1>HCSiG</h1>
      <span class="header-version">v1.7.0 ğŸ„ Christmas (Web)</span>
    </div>
    <div class="header-right">
      <span class="subtitle">Hacking Code Simulator Game</span>
      <button id="btnMore" title="ì—…ë°ì´íŠ¸ ë¡œê·¸, ë¯¸ì…˜, ì—…ì , ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°">ë”ë³´ê¸° â–¾</button>
    </div>
  </header>

  <div id="main">
    <!-- ì™¼ìª½: ìƒíƒœ / ìƒì  -->
    <div id="leftPanel" class="panel">
      <div class="section-title">Status</div>
      <div class="stat-box">
        <div class="stat-row">
          <span class="label">ë ˆë²¨</span>
          <span class="value" id="statLevel">1</span>
        </div>
        <div class="stat-row">
          <span class="label">ê²½í—˜ì¹˜</span>
          <span class="value" id="statExp">0 / 20</span>
        </div>
        <div class="stat-row">
          <span class="label">í¬ë ˆë”§</span>
          <span class="value" id="statCredits">0</span>
        </div>
        <div class="stat-row">
          <span class="label">CPU í‹°ì–´</span>
          <span class="value" id="statCpuTier">1</span>
        </div>
        <div class="stat-row">
          <span class="label">ì—ë„ˆì§€</span>
          <span class="value" id="statEnergyValue">20 / 20</span>
        </div>
        <div class="stat-row">
          <span class="label">ë‹¤ìŒ íšŒë³µê¹Œì§€</span>
          <span class="value" id="statEnergyTimer">FULL</span>
        </div>
        <div id="energyBarWrapper">
          <div id="energyBarInner"></div>
        </div>

        <div class="stat-row" style="margin-top:6px;">
          <span class="label">Trace</span>
          <span class="value" id="statTraceValue">0 / 100</span>
        </div>
        <div class="stat-row">
          <span class="label">ì°¨ë‹¨ê¹Œì§€</span>
          <span class="value" id="statTraceTimer">SAFE</span>
        </div>
        <div id="traceBarWrapper">
          <div id="traceBarInner"></div>
        </div>

                <div class="stat-row" style="align-items:center;">
          <span class="label">ì—ë„ˆì§€ íŒ©</span>
          <span class="value" style="display:flex; align-items:center; gap:6px;">
            <span id="statEnergyPack">0</span>
            <button id="btnUseEnergyPack" title="ì—ë„ˆì§€ íŒ© 1ê°œë¥¼ ì‚¬ìš©í•´ ì—ë„ˆì§€ë¥¼ ìµœëŒ€ì¹˜ê¹Œì§€ íšŒë³µí•©ë‹ˆë‹¤.">ì‚¬ìš©</button>
          </span>
        </div>

        <div class="stat-row">
          <span class="label">ë§ˆì§€ë§‰ ì €ì¥</span>
          <span class="value" id="statLastSave">-</span>
        </div>
      </div>

      <div class="section-title">Shop</div>
      <div class="shop-sort-row">
        <span class="shop-sort-label">ì •ë ¬</span>
        <select id="shopSortSelect" title="ìƒì  ì•„ì´í…œ ì •ë ¬ ê¸°ì¤€ì„ ì„ íƒí•©ë‹ˆë‹¤.">
          <option value="update">ì—…ë°ì´íŠ¸ìˆœ</option>
          <option value="new">ì‹ ê·œ ìš°ì„ </option>
          <option value="rarity">í¬ê·€ë„ìˆœ</option>
          <option value="price">ê°€ê²©ìˆœ</option>
          <option value="name">ì´ë¦„ìˆœ</option>
        </select>
      </div>
      <div class="stat-box" id="shopList"></div>
    </div>

    <div id="resizerLeft" class="resizer"></div>

    <!-- ì¤‘ì•™: í–‰ë™ / ì½”ë“œ ì¸ë²¤í† ë¦¬ / ìƒì„¸ -->
    <div id="centerPanel" class="panel">
      <div class="center-inner">
        <!-- Actions -->
        <div class="stat-box">
          <div class="section-title">Actions</div>
          <div class="button-row">
            <button id="btnScan"
              title="ì—ë„ˆì§€ 1 ì†Œëª¨. ì½”ë“œ í¬ê·€ë„ ê°€ì±  + ê²½í—˜ì¹˜ íšë“.">ì½”ë“œ ìŠ¤ìº”</button>
            <button id="btnHack"
              title="ì—ë„ˆì§€ 2 ì†Œëª¨. ì„ íƒí•œ ì½”ë“œì™€ ì„œë²„ ì •ë³´ë¡œ í•´í‚¹ì„ ì‹œë„.">ì„œë²„ í•´í‚¹</button>
            <button id="btnUpgradeCpu"
              title="CPU í‹°ì–´ ì—…ê·¸ë ˆì´ë“œ. í‹°ì–´ Ã— 500 í¬ë ˆë”§(í• ì¸ ì ìš©) ì†Œëª¨, í•´í‚¹ ì„±ê³µë¥  ì¦ê°€.">CPU ì—…ê·¸ë ˆì´ë“œ</button>
          </div>

          <div class="flex-col">
            <div class="flex-row">
              <div style="flex:1;">
                <span class="small">íƒ€ê²Ÿ ì„œë²„</span>
                <select id="serverSelect"></select>
                <div id="serverMeta" class="small" style="color:#9aa4b2; margin-top:2px;">-</div>
              </div>
              <div style="flex:1;">
                <span class="small">ë¡œë“œì•„ì›ƒ</span>
                <div class="button-row" style="margin-top:2px; gap:4px;">
                  <select id="loadoutSelect" style="max-width:90px; margin-bottom:0;">
                    <option value="1">ìŠ¬ë¡¯ 1</option>
                    <option value="2">ìŠ¬ë¡¯ 2</option>
                    <option value="3">ìŠ¬ë¡¯ 3</option>
                  </select>
                  <button id="btnSaveLoadout" title="í˜„ì¬ ì½”ë“œ / ì„œë²„ / ìœ„í—˜ ëª¨ë“œë¥¼ ì„ íƒí•œ ìŠ¬ë¡¯ì— ì €ì¥">ìŠ¬ë¡¯ ì €ì¥</button>
                  <button id="btnLoadLoadout" title="ì„ íƒí•œ ìŠ¬ë¡¯ì˜ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ê¸°">ìŠ¬ë¡¯ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
              </div>
            </div>

            <label class="small" style="margin-top:4px; display:flex; align-items:center; gap:4px;">
              <input type="checkbox" id="chkRiskMode">
              ìœ„í—˜ í•´í‚¹ ëª¨ë“œ (ì„±ê³µ í™•ë¥  -15%p + ë³´ì •, ë³´ìƒ í¬ë ˆë”§ Ã—2, ì‹¤íŒ¨ ì‹œ ì—ë„ˆì§€ ì¶”ê°€ -1)
            </label>

            <div class="small" style="margin-top:4px;">
              Â· ì—ë„ˆì§€ 1ì¹¸ = 120ì´ˆ, 0.1ì´ˆ ë‹¨ìœ„ë¡œ ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ<br>
              Â· ì½”ë“œ ìŠ¤ìº”: ì—ë„ˆì§€ 1, ìŠ¤ìº” EXP ì†ŒëŸ‰ (í¬ê·€ë„ë³„ ìŠ¤ìº” ì‹œê°„ ì°¨ë“±)<br>
              Â· ì„œë²„ í•´í‚¹: ì—ë„ˆì§€ 2, ì„±ê³µ ì‹œ í¬ë ˆë”§Â·EXP íšë“<br>
              Â· ë ˆë²¨ì—… ì‹œ í¬ë ˆë”§ +100, CPU ì—…ê·¸ë ˆì´ë“œ ë¹„ìš© = 500 Ã— í‹°ì–´ Ã— í• ì¸ ê³„ìˆ˜
            </div>
          </div>
        </div>

        <!-- Code Inventory + Detail -->
        <div class="flex-row flex-grow">
          <!-- ì½”ë“œ ì¸ë²¤í† ë¦¬ -->
          <div class="stat-box" style="flex: 0 0 45%;">
            <div class="section-title">ì½”ë“œ ì¸ë²¤í† ë¦¬</div>
            <ul id="codeList"></ul>
          </div>

          <!-- ì½”ë“œ ìƒì„¸ -->
          <div class="stat-box resizable-box" style="flex: 1 1 auto;">
            <div class="section-title">ì½”ë“œ ìƒì„¸</div>
            <div id="codeDetail">
              <div class="small">ë³´ìœ  ì¤‘ì¸ ì½”ë“œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
            <div class="button-row" style="margin-top:8px;">
              <button id="btnUpgradeCode"
                title="ì„ íƒí•œ ì½”ë“œë¥¼ ê°•í™”í•©ë‹ˆë‹¤. í¬ë ˆë”§ ì†Œëª¨, íŒŒì›Œ ì¦ê°€.">ì½”ë“œ ê°•í™”</button>
              <button id="btnEvolveCode"
                title="ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ì„ íƒí•œ ì½”ë“œë¥¼ ìƒìœ„ í¬ê·€ë„ë¡œ ì§„í™”í•©ë‹ˆë‹¤.">ì½”ë“œ ì§„í™”</button>
            </div>
            <div class="small">
              Â· ê°•í™”: ì½”ë“œ ë ˆë²¨ì— ë¹„ë¡€í•œ í¬ë ˆë”§ ì†Œëª¨, íŒŒì›Œ ì¦ê°€ (íŒŒê´´ ì—†ìŒ).<br>
              Â· ì§„í™”: ì¼ì • ë ˆë²¨ ì´ìƒ ì‹œ í¬ê·€ë„ ìŠ¹ê¸‰ (COMMON â†’ UNCOMMON â†’ â€¦ â†’ LEGENDARY).
            </div>
          </div>
        </div>

        <!-- ìŠ¤ìº” ì—°ì¶œ ì˜¤ë²„ë ˆì´ -->
        <div id="scanOverlay">
          <div id="scanProgressWrapper">
            <div id="scanProgressInner"></div>
          </div>
          <div id="scanText"></div>
        </div>
      </div>
    </div>
  </div>
    </div>
  </div>

  <!-- ë”ë³´ê¸° ëª¨ë‹¬ -->
  <div id="moreModalBackdrop">
    <div id="moreModal">
      <div id="moreModalHeader">
        <h2>ë”ë³´ê¸°</h2>
        <button id="btnMoreClose">âœ•</button>
      </div>
      <div id="moreModalBody">
        <div class="more-tabs">
          <button class="more-tab-button active" data-tab="update">ì—…ë°ì´íŠ¸ ë¡œê·¸</button>
          <button class="more-tab-button" data-tab="mission">ë¯¸ì…˜</button>
          <button class="more-tab-button" data-tab="achievement">ì—…ì </button>
          <button class="more-tab-button" data-tab="mail">ìš°í¸í•¨</button>
          <button class="more-tab-button" data-tab="logs">ë¡œê·¸</button>
          <button class="more-tab-button" data-tab="settings">ì„¤ì •</button>
          <button class="more-tab-button" data-tab="save">ë°ì´í„°</button>
        </div>

        <!-- ì—…ë°ì´íŠ¸ ë¡œê·¸ íƒ­ -->
        <div id="tabUpdate" class="more-tab-panel active">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <div>
              <span class="badge">UPDATE</span>
              <span id="updateVersionTitle"></span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
              <button id="btnUpdatePrev" title="ì´ì „ ì—…ë°ì´íŠ¸">â—€</button>
              <span id="updateIndexLabel" class="small">1 / 1</span>
              <button id="btnUpdateNext" title="ë‹¤ìŒ ì—…ë°ì´íŠ¸">â–¶</button>
            </div>
          </div>
          <div class="update-log">
            <ul id="updateLinesList"></ul>
          </div>
          <div style="margin-top:6px; display:flex; justify-content:flex-end;">
            <button id="btnUpdateDontShow" class="small"
              title="ë‹¤ìŒ ì—…ë°ì´íŠ¸ê°€ ë‚˜ì˜¤ê¸° ì „ê¹Œì§€ ì‹œì‘ ì‹œ ìë™ íŒì—…ì„ í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.">
              ì´í›„ ë”ë³´ê¸°ì—ì„œ í™•ì¸
            </button>
          </div>
        </div>

        <!-- ë¯¸ì…˜ íƒ­ -->
        <div id="tabMission" class="more-tab-panel">
          <div>
            <span class="badge">MISSION</span>
            <span>í€˜ìŠ¤íŠ¸</span>
          </div>
          <div class="mission-scope-tabs">
            <button class="mission-scope-btn active" data-scope="daily">DAILY</button>
            <button class="mission-scope-btn" data-scope="weekly">WEEKLY</button>
            <button class="mission-scope-btn" data-scope="month">MONTH</button>
            <button class="mission-scope-btn" data-scope="general">GENERAL</button>
            <button class="mission-scope-btn" data-scope="stage">STAGE</button>
          </div>
          <div class="stat-box" id="missionList"></div>
        </div>

        <!-- ì—…ì  íƒ­ -->
        <div id="tabAchievement" class="more-tab-panel">
          <div>
            <span class="badge">ACHIEVEMENT</span>
            <span>ì—…ì </span>
          </div>
          
        <!-- ìš°í¸í•¨ íƒ­ -->
        <div id="tabMail" class="more-tab-panel">
          <div>
            <span class="badge">MAIL</span>
            <span>ìš°í¸í•¨</span>
          </div>

          <div class="mail-topbar">
            <div class="mail-count" id="mailCountText">ë³´ê´€í•¨: 0ê°œ</div>
            <div class="button-row" style="margin:0;">
              <button id="btnClaimAllMail" title="ìˆ˜ë ¹ ê°€ëŠ¥í•œ ìš°í¸ì˜ ë³´ìƒì„ ëª¨ë‘ ìˆ˜ë ¹í•©ë‹ˆë‹¤.">ëª¨ë‘ ìˆ˜ë ¹</button>
            </div>
          </div>

          <div class="stat-box" id="mailList"></div>

          <div class="small" style="opacity:0.85; margin-top:6px;">
            â€¢ ë³´ìƒì€ ìˆ˜ë ¹ ì‹œ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤. (í¬ë ˆë”§ / ì—ë„ˆì§€ íŒ© ë“±)<br>
            â€¢ ì´ë²¤íŠ¸ ìš°í¸ì€ ê¸°ê°„ì´ ì§€ë‚˜ë©´ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>

<div class="stat-box" id="achievementList"></div>
        </div>


        <!-- ë¡œê·¸ íƒ­ -->
        <div id="tabLogs" class="more-tab-panel">
          <div>
            <span class="badge">LOG</span>
            <span>ê¸°ë¡</span>
          </div>
          <div style="margin-top:8px;">
<div class="stat-box" style="margin-bottom:6px;">
  <div class="small" style="margin-bottom:4px; opacity:0.9;">ë¡œê·¸ ê²€ìƒ‰ (ë¡œê·¸ í•­ëª© í´ë¦­ â†’ í•€/í•´ì œ)</div>
  <input id="logSearchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." style="width:100%; padding:8px 10px; border-radius:10px; border:1px solid #243145; background:#0b1220; color:#e5e7eb;">
</div>

<div class="button-row" style="margin-bottom:4px;">
        <button id="btnClearLogs" title="í˜„ì¬ ë¡œê·¸ë¥¼ ëª¨ë‘ ì§€ì›ë‹ˆë‹¤.">ë¡œê·¸ ì´ˆê¸°í™”</button>
        <button id="btnToggleLogs" title="ë¡œê·¸ ì˜ì—­ì„ ìˆ¨ê¸°ê±°ë‚˜ ë‹¤ì‹œ í‘œì‹œí•©ë‹ˆë‹¤.">ë¡œê·¸ ìˆ¨ê¸°ê¸°</button>
      </div>
      <div id="logPanelBody">
        <div class="stat-box small" style="margin-bottom:6px;">
          <div style="margin-bottom:2px; opacity:0.9;">ë¡œê·¸ í•„í„°</div>
          <label class="log-filter-label"><input type="checkbox" id="filterSystem" checked> SYSTEM</label>
          <label class="log-filter-label"><input type="checkbox" id="filterScan" checked> SCAN</label>
          <label class="log-filter-label"><input type="checkbox" id="filterHack" checked> HACK</label>
          <label class="log-filter-label"><input type="checkbox" id="filterShop" checked> SHOP</label>
          <label class="log-filter-label"><input type="checkbox" id="filterLevel" checked> LEVEL</label>
        </div>
        <div class="stat-box resizable-box" id="logBox">
          <div id="logList"></div>
        </div>
      </div>
    
          </div>
        </div>

        <!-- ì„¤ì • íƒ­ -->
        <div id="tabSettings" class="more-tab-panel">
          <div>
            <span class="badge">SETTINGS</span>
            <span>í™˜ê²½ ì„¤ì •</span>
          </div>

          <div class="stat-box" style="font-size:12px; margin-top:8px;">
            <div class="stat-row" style="align-items:center;">
              <span class="label">í°íŠ¸ í¬ê¸°</span>
              <span class="value" style="display:flex; align-items:center; gap:10px;">
                <input id="setFontScale" type="range" min="90" max="120" step="5" style="width:180px;">
                <span id="setFontScaleLabel">100%</span>
              </span>
            </div>

            <div class="stat-row" style="align-items:center;">
              <span class="label">UI ìŠ¤ì¼€ì¼</span>
              <span class="value">
                <select id="setUiZoom" title="ì „ì²´ UI ë°°ìœ¨ì„ ì¡°ì •í•©ë‹ˆë‹¤.">
                  <option value="0.8">0.8x</option>
                  <option value="1">1.0x</option>
                  <option value="1.2">1.2x</option>
                </select>
              </span>
            </div>

            <div class="stat-row" style="align-items:center;">
              <span class="label">ì• ë‹ˆë©”ì´ì…˜</span>
              <span class="value">
                <label class="log-filter-label" style="display:inline-flex; align-items:center; gap:6px;">
                  <input id="setAnim" type="checkbox" checked> ì‚¬ìš©
                </label>
              </span>
            </div>

            <div class="stat-row" style="align-items:center;">
              <span class="label">í† ìŠ¤íŠ¸ ì‹œê°„</span>
              <span class="value">
                <select id="setToastMs" title="í™”ë©´ ì•Œë¦¼(í† ìŠ¤íŠ¸) í‘œì‹œ ì‹œê°„ì„ ì„¤ì •í•©ë‹ˆë‹¤.">
                  <option value="3000">3ì´ˆ</option>
                  <option value="5000">5ì´ˆ</option>
                  <option value="7000">7ì´ˆ</option>
                </select>
              </span>
            </div>

            <div class="stat-row" style="align-items:center;">
              <span class="label">ìë™ì €ì¥ ì•Œë¦¼</span>
              <span class="value">
                <label class="log-filter-label" style="display:inline-flex; align-items:center; gap:6px;">
                  <input id="setAutoSaveToast" type="checkbox"> í‘œì‹œ
                </label>
              </span>
            </div>

            <div class="small" style="margin-top:6px;">
              Â· ì„¤ì •ì€ ì €ì¥ ë°ì´í„°ì— í¬í•¨ë˜ë©°, ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ìœ ì§€ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>

        <!-- ì €ì¥ íƒ­ -->
        <div id="tabSave" class="more-tab-panel">
          <div>
            <span class="badge">SAVE</span>
            <span>ë°ì´í„° ê´€ë¦¬</span>
          </div>
          <div class="stat-box" style="font-size:12px;">
            <div class="button-row">
              <button id="btnSaveGame" title="í˜„ì¬ ìƒíƒœë¥¼ ë¸Œë¼ìš°ì € LocalStorageì— ì €ì¥í•©ë‹ˆë‹¤.">ì €ì¥í•˜ê¸°</button>
              <button id="btnLoadGame" title="LocalStorageì—ì„œ ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.">ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button id="btnClearSave" title="ì €ì¥ ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.">ì €ì¥ ë°ì´í„° ì‚­ì œ</button>
            </div>
            <div class="button-row" style="margin-top:6px;">
              <button id="btnExportSave" title="í˜„ì¬ ì €ì¥ ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.">ë‚´ë³´ë‚´ê¸°</button>
              <button id="btnImportSaveFile" title="JSON ì €ì¥ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.">íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <input id="fileImportSave" type="file" accept="application/json" style="display:none;">
            </div>

            <div class="small" style="margin-top:8px; opacity:0.95;">í…ìŠ¤íŠ¸ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°</div>
            <textarea id="importSaveText" style="width:100%; height:90px; margin-top:6px; background:#0b1220; border:1px solid #243145; color:#e5e7eb; border-radius:10px; padding:10px; font-size:12px;" placeholder="ì—¬ê¸°ì— JSONì„ ë¶™ì—¬ë„£ê³  ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”."></textarea>
            <div class="button-row" style="margin-top:6px;">
              <button id="btnImportSaveText" title="í…ìŠ¤íŠ¸(JSON)ë¡œ ì €ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.">í…ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>

            <div class="small">
              Â· ì €ì¥ ìœ„ì¹˜: ë¸Œë¼ìš°ì € LocalStorage (ì´ ë¸Œë¼ìš°ì €, ì´ ê¸°ê¸° í•œì •)<br>
              Â· ìë™ ì €ì¥: ì•½ 60ì´ˆë§ˆë‹¤ í•œ ë²ˆì”© ë°±ê·¸ë¼ìš´ë“œ ì €ì¥
            </div>
          </div>
        </div>
      </div>
      <div id="moreModalFooter">
        <button id="btnMoreClose2">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <div id="toastContainer"></div>

  <script>
    const CURRENT_VERSION = 'v1.7.0';
    const ENERGY_INTERVAL_MS = 120000; // ì—ë„ˆì§€ 1ì¹¸ë‹¹ 120ì´ˆ
    const SAVE_KEY = 'HCSiG_SAVE_v17';
    const OLD_SAVE_KEY = 'HCSiG_SAVE_v16';
    const LEGACY_SAVE_KEY = 'HCSiG_SAVE_v15';
    const LAST_SEEN_VERSION_KEY = 'HCSiG_LAST_SEEN_VERSION';

    // ì—…ë°ì´íŠ¸ ë¡œê·¸
    const updateLogs = [
      {
        version: 'HackSim Java Edition â†’ HCSiG Web',
        lines: [
          'Player, Code, TargetServer, CPU í‹°ì–´, ì„±ê³µ í™•ë¥  ê³µì‹ì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.',
          'í•œê¸€ UI, í˜„ì‹¤ ì‹œê°„ ê¸°ë°˜ ìŠ¤ìº” ì—ë„ˆì§€, ê°„ë‹¨í•œ ì¸ë²¤í† ë¦¬ë¥¼ ê°œë°œí–ˆìŠµë‹ˆë‹¤.',
          'ì¢Œ/ì¤‘/ìš° íŒ¨ë„ ì‚¬ì´ì¦ˆ ì¡°ì • ê¸°ëŠ¥, ì½”ë“œ ìŠ¤ìº”, í•´í‚¹, CPU ì—…ê·¸ë ˆì´ë“œë¥¼ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.'
        ]
      },
      {
        version: 'v1.3.x',
        lines: [
          'ì—ë„ˆì§€ ì‹œìŠ¤í…œì„ ê°œí¸í–ˆìŠµë‹ˆë‹¤.',
          'ë ˆë²¨ì—… ì‹œ í¬ë ˆë”§ì„ íšë“í•  ìˆ˜ ìˆë„ë¡ ì¡°ì •í–ˆìŠµë‹ˆë‹¤.',
          'í•„ìš” EXP ê³¡ì„  ì¡°ì •ìœ¼ë¡œ ì„±ì¥ ì†ë„ë¥¼ ì™„í™”í–ˆìŠµë‹ˆë‹¤.',
          'ì½”ë“œ ì¸ë²¤í† ë¦¬ & ìƒì„¸ íŒ¨ë„, ì½”ë“œ ê°•í™”/ì§„í™” ë²„íŠ¼ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.',
          'ìƒì  ì‹ ê·œ ì•„ì´í…œ, ë²„íŠ¼ íˆ´íŒ, ë¡œê·¸/ì½”ë“œ ìƒì„¸ ìƒí•˜ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥, ë”ë³´ê¸° ëª¨ë‹¬ì„ ë„ì…í–ˆìŠµë‹ˆë‹¤.'
        ]
      },
      {
        version: 'v1.4.x',
        lines: [
          'ìœ„í—˜ í•´í‚¹ ëª¨ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
          'ë¡œê·¸ í•„í„°, ë¡œë“œì•„ì›ƒ(í”„ë¦¬ì…‹) 3ìŠ¬ë¡¯ì„ ê¸°ë³¸ì„¤ì •í–ˆìŠµë‹ˆë‹¤.',
          'ë°ì¼ë¦¬/ìœ„í´ë¦¬ ë¯¸ì…˜, ì—…ì  ì‹œìŠ¤í…œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'
        ]
      },
      {
        version: 'v1.5.x',
        lines: [
          'ì½”ë“œ ë“±ê¸‰ë³„ ìƒ‰ìƒì„ ì ìš©í•˜ê³ , ìŠ¤ìº” ì—°ì¶œ í¬ê¸°ì™€ í¬ê·€ë„ë³„ ìŠ¤ìº” ì‹œê°„ì„ ì¡°ì •í–ˆìŠµë‹ˆë‹¤.',
          'ì—…ë°ì´íŠ¸ ë¡œê·¸ ë·°ì–´ì— ì¢Œìš° ì´ë™ ë° íƒ­ UIë¥¼ ì¶”ê°€í•˜ê³ , ì‹œì‘ ì‹œ ìë™ íŒì—…ì—ì„œë§Œ â€˜ì´í›„ ë”ë³´ê¸°ì—ì„œ í™•ì¸â€™ì„ ë…¸ì¶œí•˜ë„ë¡ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.',
          'DAILY / WEEKLY / MONTH QUESTë¥¼ ë¶„ë¦¬ íƒ­ìœ¼ë¡œ êµ¬ì„±í•˜ê³ , ì¥ê¸° ì§„í–‰í˜• GENERAL QUESTë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.',
          'ìƒì ì— í¬ê·€ë„Â·ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ ì•„ì´í…œ 8ì¢…ì„ ì¶”ê°€í•˜ê³ , ì—…ì  ê°œìˆ˜ë¥¼ í™•ì¥í–ˆìŠµë‹ˆë‹¤.'
        ]
      },
      {
        version: 'v1.6.0',
        lines: [
          'ì—ë„ˆì§€ íŒ©(ì¸ë²¤í† ë¦¬)ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. Statusì—ì„œ ë³´ìœ  ìˆ˜ëŸ‰ í™•ì¸ ë° ì¦‰ì‹œ ì‚¬ìš©ìœ¼ë¡œ ì—ë„ˆì§€ë¥¼ ìµœëŒ€ì¹˜ê¹Œì§€ íšŒë³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
          'ìƒì ì— ì—ë„ˆì§€ íŒ©ì„ ì¶”ê°€í•˜ê³ , êµ¬ë§¤ ì‹œ ì¸ë²¤í† ë¦¬ê°€ ì¦ê°€í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.',
          'DAILY í€˜ìŠ¤íŠ¸ì— â€œì½”ë“œ ìŠ¤ìº”/ì„œë²„ í•´í‚¹ ì´ 10íšŒ â†’ í¬ë ˆë”§ + ì—ë„ˆì§€ íŒ© 1ê°œâ€ ë³´ìƒì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.',
          'ì™¼ìª½ íŒ¨ë„ì—ì„œ STATUSëŠ” ê³ ì •ë˜ê³ , SHOP ëª©ë¡ë§Œ ë‚´ë¶€ ìŠ¤í¬ë¡¤ë˜ë„ë¡ UIë¥¼ ê°œì„ í–ˆìŠµë‹ˆë‹¤.',
          'ì €ì¥ í‚¤ë¥¼ v16ìœ¼ë¡œ ë¶„ë¦¬í•˜ê³ (v15 â†’ v16) ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§€ì›í•©ë‹ˆë‹¤.'
        ]
      },
      {
        version: 'v1.6.1',
        lines: [
          'ìƒì  ì •ë ¬ ì˜µì…˜(ì—…ë°ì´íŠ¸ìˆœ/í¬ê·€ë„ìˆœ)ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.',
          'ë¯¸ì…˜/ì—…ì  ë‹¬ì„± ì‹œ í™”ë©´ ì•Œë¦¼(í† ìŠ¤íŠ¸)ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. (ë¡œê·¸ì™€ ë³„ê°œ)',
          'ë¡œê·¸ íŒ¨ë„ì„ ë©”ì¸ í™”ë©´ì—ì„œ ì œê±°í•˜ê³ , ë”ë³´ê¸° íƒ­ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.'
        ]
      },
      {
        version: 'v1.6.2',
        lines: [
          'ë”ë³´ê¸° ë²„íŠ¼ í´ë¦­ ë²„ê·¸ë¥¼ ìˆ˜ì •í•˜ê³ , ëª¨ë‹¬ ì˜¤í”ˆ ê°€ë“œ ë° ë ˆì´ì–´ ìš°ì„ ìˆœìœ„ë¥¼ ë³´ê°•í–ˆìŠµë‹ˆë‹¤.'
        ]
      },
      {
        version: 'v1.6.5',
        lines: [
          'ìƒì  ì •ë ¬ ì˜µì…˜ì„ í™•ì¥í–ˆìŠµë‹ˆë‹¤. (ì—…ë°ì´íŠ¸ìˆœ/ì‹ ê·œìš°ì„ /í¬ê·€ë„ìˆœ/ê°€ê²©ìˆœ/ì´ë¦„ìˆœ)',
          'ì„¤ì • íƒ­ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. (í°íŠ¸ í¬ê¸°, UI ìŠ¤ì¼€ì¼, ì• ë‹ˆë©”ì´ì…˜, í† ìŠ¤íŠ¸ ì‹œê°„, ìë™ì €ì¥ ì•Œë¦¼)',
          'ë°ì´í„° íƒ­ì—ì„œ ì €ì¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°(íŒŒì¼/í…ìŠ¤íŠ¸)ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.',
          'ë¡œê·¸ ê²€ìƒ‰/í•€ ê¸°ëŠ¥ê³¼ ìµœëŒ€ 100ê°œ í‘œì‹œ(í•€ ì œì™¸) ì œí•œì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.',
          'ë§ˆì§€ë§‰ ì €ì¥ ì‹œê° í‘œì‹œ ë° ìë™ì €ì¥ UXë¥¼ ê°œì„ í–ˆìŠµë‹ˆë‹¤.'
        ]
      },
      {
        version: 'v1.7.0',
        lines: [
          'Trace Protocolì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. (Trace ê²Œì´ì§€/ì°¨ë‹¨ íƒ€ì´ë¨¸/ìì—° ê°ì†Œ)',
          'ì„œë²„ì— ë°©í™”ë²½(FW), ì¶”ì ê°ë„(Trace), ë³´ìƒê³„ìˆ˜ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.',
          'ìŠ¤ìº”/í•´í‚¹ í–‰ë™ì— ë”°ë¼ Traceê°€ ìƒìŠ¹í•˜ë©°, 100 ë„ë‹¬ ì‹œ ì¼ì • ì‹œê°„ ì°¨ë‹¨ë©ë‹ˆë‹¤.'
        ]
      }

    ];

    let activeUpdateIndex = updateLogs.length - 1;

    const state = {
      level: 1,
      exp: 0,
      requiredExp: 20,
      credits: 0,
      cpuTier: 1,
      energy: 20,
      energyMax: 20,
      energyTimerMs: 0,
      trace: 0,
      traceMax: 100,
      traceLockMs: 0,
      traceDecayAccMs: 0,
      items: { energyPack: 0 },
      lastSavedAt: null,
      activeCodeId: null,
      riskMode: false,
      missionProgress: {
        daily: {
          scans: 0,
          actions: 0,
          hackSuccess: 0,
          energySpent: 0,
          lastResetDay: null,
          completed: {}
        },
        weekly: {
          scans: 0,
          hackSuccess: 0,
          energySpent: 0,
          levelReached: 1,
          lastResetWeek: null,
          completed: {}
        },
        month: {
          scans: 0,
          hackSuccess: 0,
          energySpent: 0,
          levelReached: 1,
          lastResetMonth: null,
          completed: {}
        },
        general: {
          completed: {}
        },
        stage: { completed: {} }
      },
      achievements: {},
      loadouts: {
        1: { codeId: null, serverId: null, riskMode: false },
        2: { codeId: null, serverId: null, riskMode: false },
        3: { codeId: null, serverId: null, riskMode: false }
      },
      logFilter: {
        system: true,
        scan: true,
        hack: true,
        shop: true,
        level: true
      },
      ui: { shopSortMode: 'update', toastDurationMs: 3000, uiZoom: 1, fontScale: 100, anim: true, autoSaveToast: false, logSearch: '' },
      stats: {
        scanCount: 0,
        hackSuccessCount: 0,
        shopPurchaseCount: 0,
        energySpentTotal: 0,
        creditsEarnedTotal: 0,
        missionsCompletedTotal: 0,
        riskHackSuccessCount: 0,
        // v1.7.x ì½˜í…ì¸  ì¹´ìš´í„°
        traceReducedCount: 0,
        traceZeroCount: 0,
        stealthHackSuccessCount: 0,
        highTraceHackSuccessCount: 0,
        lockdownCount: 0,
        postLockSuccessCount: 0,
        logLinesTotal: 0,
        successStreak: 0,
        successStreakMax: 0,
        failStreak: 0,
        failStreakMax: 0,
        ghostSuccessAtTrace0: 0,
        sameActionStreak: 0,
        sameActionLast: null,
        silentNightStartAt: null,
        silentNightBroken: false,
        lastLogWasFailOrWarnAt: null,
        energy0Attempted: false,
        lockAttempted: false,
        justUnlockedFromLock: false,
        postLockPending: false
      }
    };

    // =========================
    // Christmas + Mailbox System
    // =========================
    function ensureMailbox() {
      if (!state.mailbox || typeof state.mailbox !== 'object') {
        state.mailbox = { messages: [], flags: {}, lastDailyGiftKey: null };
      }
      if (!Array.isArray(state.mailbox.messages)) state.mailbox.messages = [];
      if (!state.mailbox.flags || typeof state.mailbox.flags !== 'object') state.mailbox.flags = {};
      if (typeof state.mailbox.lastDailyGiftKey !== 'string' && state.mailbox.lastDailyGiftKey !== null) {
        state.mailbox.lastDailyGiftKey = null;
      }
    }

    function mailRewardText(rw) {
      const parts = [];
      if (!rw) return 'ë³´ìƒ ì—†ìŒ';
      if (rw.credits) parts.push(`í¬ë ˆë”§ +${rw.credits}`);
      if (rw.energyPack) parts.push(`ì—ë„ˆì§€ íŒ© +${rw.energyPack}`);
      if (rw.energyMax) parts.push(`ì—ë„ˆì§€ ìµœëŒ€ì¹˜ +${rw.energyMax}`);
      return parts.length ? parts.join(' / ') : 'ë³´ìƒ ì—†ìŒ';
    }

    function addMail(msg) {
      ensureMailbox();
      // de-dupe by id
      if (state.mailbox.messages.some(m => m.id === msg.id)) return false;
      state.mailbox.messages.unshift(msg);
      return true;
    }

    function pruneExpiredMail() {
      ensureMailbox();
      const now = Date.now();
      state.mailbox.messages = state.mailbox.messages.filter(m => {
        if (!m.expiresAt) return true;
        return now <= m.expiresAt;
      });
    }

    function getUnreadMailCount() {
      ensureMailbox();
      return state.mailbox.messages.filter(m => !m.claimed).length;
    }

    function updateMoreButtonBadge() {
      const btn = document.getElementById('btnMore');
      if (!btn) return;
      const n = getUnreadMailCount();
      // keep text but append dot badge
      btn.dataset.unread = String(n);
      btn.style.position = 'relative';
      let dot = btn.querySelector('.unread-dot');
      if (!dot) {
        dot = document.createElement('span');
        dot.className = 'unread-dot';
        dot.style.position = 'absolute';
        dot.style.top = '6px';
        dot.style.right = '8px';
        dot.style.minWidth = '16px';
        dot.style.height = '16px';
        dot.style.padding = '0 4px';
        dot.style.borderRadius = '999px';
        dot.style.fontSize = '11px';
        dot.style.display = 'inline-flex';
        dot.style.alignItems = 'center';
        dot.style.justifyContent = 'center';
        dot.style.border = '1px solid #263247';
        dot.style.background = 'rgba(11, 18, 32, 0.9)';
        dot.style.opacity = '0.95';
        btn.appendChild(dot);
      }
      if (n > 0) {
        dot.textContent = n > 99 ? '99+' : String(n);
        dot.style.display = 'inline-flex';
      } else {
        dot.style.display = 'none';
      }
    }

    function ensureChristmasMails() {
      ensureMailbox();
      pruneExpiredMail();

      // One-time "Christmas Gift" mail (kept for the season build)
      if (!state.mailbox.flags.xmasGiftV1) {
        addMail({
          id: 'xmas_gift_v1',
          title: 'ğŸ„ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì„ ë¬¼ ì§€ê¸‰',
          body: 'í•´ì»¤ë‹˜ì„ ìœ„í•œ ì‘ì€ ì„ ë¬¼ì„ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤.\nì¦ê±°ìš´ ì—°ë§ ë˜ì„¸ìš”!\n\nâ€” HCSiG ìš´ì˜íŒ€',
          rewards: { credits: 300, energyPack: 1 },
          createdAt: Date.now(),
          claimed: false
        });
        state.mailbox.flags.xmasGiftV1 = true;
      }

      // Daily login gift during December (KST reset key ê¸°ë°˜)
      const d = new Date();
      const isDecember = (d.getMonth() === 11); // 0=Jan
      if (isDecember) {
        const todayKey = getLocalDateKey();
        if (state.mailbox.lastDailyGiftKey !== todayKey) {
          // small gift
          addMail({
            id: `xmas_daily_${todayKey}`,
            title: 'ğŸ ì—°ë§ ì¶œì„ ë³´ìƒ',
            body: 'ì˜¤ëŠ˜ë„ ì ‘ì†í•´ì¤˜ì„œ ê³ ë§ˆì›Œìš”!\n(05:00 KST ê¸°ì¤€ 1ì¼ 1íšŒ)',
            rewards: { credits: 60 },
            createdAt: Date.now(),
            expiresAt: Date.now() + 1000 * 60 * 60 * 24 * 14, // 14 days
            claimed: false
          });
          state.mailbox.lastDailyGiftKey = todayKey;
        }
      }

      updateMoreButtonBadge();
    }

    function applyMailRewards(rewards) {
      if (!rewards) return;
      if (rewards.credits) state.credits += rewards.credits;
      if (rewards.energyPack) state.items.energyPack = (state.items.energyPack || 0) + rewards.energyPack;
      if (rewards.energyMax) {
        state.energyMax += rewards.energyMax;
        state.energy = Math.min(state.energyMax, state.energy);
      }
      updateStatsUI();
      refreshShopUI?.();
    }

    function claimMailById(id) {
      ensureMailbox();
      const mail = state.mailbox.messages.find(m => m.id === id);
      if (!mail || mail.claimed) return false;
      mail.claimed = true;
      applyMailRewards(mail.rewards);
      log(`[ìš°í¸í•¨] "${mail.title}" ë³´ìƒì„ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤. (${mailRewardText(mail.rewards)})`, 'system');
      showToast('ìš°í¸ ìˆ˜ë ¹ ì™„ë£Œ', 'ok');
      updateMoreButtonBadge();
      saveGame(true);
      return true;
    }

    function claimAllMail() {
      ensureMailbox();
      let claimed = 0;
      state.mailbox.messages.forEach(m => {
        if (!m.claimed) {
          m.claimed = true;
          applyMailRewards(m.rewards);
          claimed++;
        }
      });
      if (claimed > 0) {
        log(`[ìš°í¸í•¨] ìˆ˜ë ¹ ê°€ëŠ¥í•œ ìš°í¸ ${claimed}ê°œë¥¼ ëª¨ë‘ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤.`, 'system');
        showToast(`ìš°í¸ ${claimed}ê°œ ìˆ˜ë ¹`, 'ok');
        updateMoreButtonBadge();
        saveGame(true);
      } else {
        showToast('ìˆ˜ë ¹í•  ìš°í¸ì´ ì—†ìŠµë‹ˆë‹¤.', 'warn');
      }
      return claimed;
    }

    function renderMailbox() {
      ensureMailbox();
      pruneExpiredMail();
      const wrap = document.getElementById('mailList');
      const countText = document.getElementById('mailCountText');
      if (!wrap) return;
      wrap.innerHTML = '';

      const total = state.mailbox.messages.length;
      const unread = getUnreadMailCount();
      if (countText) countText.textContent = `ë³´ê´€í•¨: ${total}ê°œ (ìˆ˜ë ¹ ê°€ëŠ¥ ${unread}ê°œ)`;

      if (total === 0) {
        const empty = document.createElement('div');
        empty.className = 'small';
        empty.style.opacity = '0.85';
        empty.textContent = 'ìƒˆë¡œìš´ ìš°í¸ì´ ì—†ìŠµë‹ˆë‹¤.';
        wrap.appendChild(empty);
        return;
      }

      state.mailbox.messages.forEach(m => {
        const item = document.createElement('div');
        item.className = 'mail-item' + (m.claimed ? ' mail-claimed' : '');
        const title = document.createElement('div');
        title.className = 'mail-title';

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.alignItems = 'center';
        left.style.gap = '8px';

        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.textContent = m.claimed ? 'ìˆ˜ë ¹ì™„ë£Œ' : 'ìˆ˜ë ¹ ê°€ëŠ¥';
        left.appendChild(pill);

        const t = document.createElement('span');
        t.textContent = m.title || 'ìš°í¸';
        left.appendChild(t);

        title.appendChild(left);

        const btn = document.createElement('button');
        btn.textContent = m.claimed ? 'ì™„ë£Œ' : 'ìˆ˜ë ¹';
        btn.disabled = !!m.claimed;
        btn.addEventListener('click', () => {
          claimMailById(m.id);
          renderMailbox();
        });
        title.appendChild(btn);

        const meta = document.createElement('div');
        meta.className = 'mail-meta';
        const created = m.createdAt ? new Date(m.createdAt) : null;
        const createdTxt = created ? `${created.getFullYear()}-${String(created.getMonth()+1).padStart(2,'0')}-${String(created.getDate()).padStart(2,'0')}` : '';
        const expTxt = m.expiresAt ? ` Â· ë§Œë£Œ: ${new Date(m.expiresAt).toLocaleDateString()}` : '';
        meta.textContent = (createdTxt ? `ìˆ˜ì‹ : ${createdTxt}` : 'ìˆ˜ì‹ ') + expTxt;

        const body = document.createElement('div');
        body.className = 'mail-body';
        body.textContent = m.body || '';

        const reward = document.createElement('div');
        reward.className = 'mail-reward';

        const rw = document.createElement('div');
        rw.textContent = `ë³´ìƒ: ${mailRewardText(m.rewards)}`;
        reward.appendChild(rw);

        item.appendChild(title);
        item.appendChild(meta);
        item.appendChild(body);
        item.appendChild(reward);

        wrap.appendChild(item);
      });
    }

    // Simple snow effect (no images)
    function setupSnow() {
      const layer = document.getElementById('snowLayer');
      if (!layer) return;

      // Allow user to disable via settings
      const enabled = !(state.ui && state.ui.seasonalTheme === false);
      layer.innerHTML = '';
      if (!enabled) return;

      const count = 36;
      const h = window.innerHeight || 800;
      for (let i = 0; i < count; i++) {
        const flake = document.createElement('div');
        flake.className = 'snowflake';
        const size = 2 + Math.random() * 6;
        flake.style.width = `${size}px`;
        flake.style.height = `${size}px`;
        flake.style.left = `${Math.random() * 100}%`;
        flake.style.opacity = `${0.25 + Math.random() * 0.7}`;
        flake.style.background = 'rgba(255,255,255,0.9)';
        flake.style.animationDuration = `${6 + Math.random() * 10}s`;
        flake.style.animationDelay = `${Math.random() * 6}s`;
        // slight horizontal drift using translateX in keyframes via CSS variables isn't available; emulate with margin-left over time
        flake.style.marginLeft = `${-10 + Math.random() * 20}px`;
        layer.appendChild(flake);
      }
    }

    const codeDefs = {
      basic: {
        id: 'basic',
        name: 'Basic_Probe',
        rarity: 'COMMON',
        basePower: 15,
        description: 'ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ì½”ë“œ. ì¶”ê°€ íš¨ê³¼ ì—†ìŒ.'
      },
      port_scanner: {
        id: 'port_scanner',
        name: 'Port_Scanner',
        rarity: 'COMMON',
        basePower: 18,
        description: 'í•´í‚¹ ì‹œ ëŒ€ìƒ ì„œë²„ ë³´ì•ˆ -10%ë¥¼ ì ìš©í•©ë‹ˆë‹¤.'
      },
      data_phantom: {
        id: 'data_phantom',
        name: 'Data_Phantom',
        rarity: 'RARE',
        basePower: 22,
        description: 'í•´í‚¹ ì„±ê³µ í™•ë¥ ì„ +10%p ì¦ê°€ì‹œí‚µë‹ˆë‹¤.'
      },
      overflow_inject: {
        id: 'overflow_inject',
        name: 'Overflow_Inject',
        rarity: 'EPIC',
        basePower: 26,
        description: 'ì„±ê³µ ì‹œ í¬ë ˆë”§ +30%, ì‹¤íŒ¨ ì‹œ ì—ë„ˆì§€ë¥¼ 1 ì¶”ê°€ë¡œ ì†Œëª¨í•©ë‹ˆë‹¤.'
      },
      ghost_script: {
        id: 'ghost_script',
        name: 'Ghost_Script',
        rarity: 'LEGENDARY',
        basePower: 30,
        description: 'í•´í‚¹ ì„±ê³µ ì‹œ ì¶”ê°€ ë ˆë²¨ ì—… 1íšŒë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.'
      },
      auto_patch: {
        id: 'auto_patch',
        name: 'AutoPatch()',
        rarity: 'RARE',
        basePower: 20,
        description: 'í•´í‚¹ ì‹¤íŒ¨ ì‹œ 20% í™•ë¥ ë¡œ ê²½í—˜ì¹˜ +1 ë³´ì •ì„ ì œê³µí•©ë‹ˆë‹¤.'
      }
    };

    const rarityOrder = ['COMMON', 'UNCOMMON', 'RARE', 'EPIC', 'LEGENDARY'];

    const rarityWeights = {
      COMMON: 50,
      UNCOMMON: 25,
      RARE: 15,
      EPIC: 7,
      LEGENDARY: 3
    };

    const rarityPowerUp = {
      COMMON: 3,
      UNCOMMON: 5,
      RARE: 8,
      EPIC: 12,
      LEGENDARY: 20
    };

    const ownedCodes = [];

    const servers = [
      {
        id: 'school_lab',
        name: 'í•™êµ ì‹¤ìŠµ ì„œë²„',
        security: 20,
        minReward: 10,
        maxReward: 25,
        minLevel: 1
      },
      {
        id: 'bank_backup',
        name: 'ì€í–‰ ë°±ì—… ë…¸ë“œ',
        security: 35,
        minReward: 25,
        maxReward: 50,
        minLevel: 2
      },
      {
        id: 'gov_archive',
        name: 'ì •ë¶€ ê¸°ë¡ ë³´ê´€ ë…¸ë“œ',
        security: 50,
        minReward: 40,
        maxReward: 80,
        minLevel: 3
      },
      {
        id: 'central_core',
        name: 'ì¤‘ì•™ ì½”ì–´ ê·¸ë¦¬ë“œ',
        security: 70,
        minReward: 70,
        maxReward: 140,
        minLevel: 4
      },
      {
        id: 'deep_space',
        name: 'ë”¥ ìŠ¤í˜ì´ìŠ¤ ë¦´ë ˆì´',
        security: 90,
        minReward: 100,
        maxReward: 200,
        minLevel: 5
      }
    ];

    // Trace Protocol: ì„œë²„ ì†ì„± ìë™ ë¶€ì—¬ (FW/ì¶”ì ê°ë„/ë³´ìƒê³„ìˆ˜)
    servers.forEach(s => {
      if (typeof s.firewall !== 'number') {
        s.firewall = Math.round(s.security * 1.1 + s.minLevel * 6);
      }
      if (typeof s.traceSensitivity !== 'number') {
        s.traceSensitivity = Math.max(1.0, Math.min(2.6, Number((1 + s.security / 100).toFixed(2))));
      }
      if (typeof s.rewardMultiplier !== 'number') {
        s.rewardMultiplier = Math.max(1.0, Number((1 + s.minLevel * 0.15 + s.security / 300).toFixed(2)));
      }
    });

    // ìƒì  ì•„ì´í…œ + ì¹´í…Œê³ ë¦¬ + í¬ê·€ë„
    const shopItems = [
      {
        id: 'energy_pack',
        name: 'ì—ë„ˆì§€ íŒ©',
        desc: 'ì¸ë²¤í† ë¦¬ì— ì €ì¥ë˜ëŠ” ì†Œëª¨í’ˆ. ì‚¬ìš© ì‹œ ì—ë„ˆì§€ë¥¼ ìµœëŒ€ì¹˜ê¹Œì§€ íšŒë³µí•©ë‹ˆë‹¤.',
        cost: 280,
        rarity: 'UNCOMMON',
        category: 'ENERGY',
        buy: () => {
          state.items.energyPack = (state.items.energyPack || 0) + 1;
        }
      },
      {
        id: 'energy_boost_1',
        name: 'ì—ë„ˆì§€ ë¶€ìŠ¤í„° I',
        desc: 'ì¦‰ì‹œ ì—ë„ˆì§€ +5.',
        cost: 150,
        rarity: 'COMMON',
        category: 'ENERGY',
        buy: () => {
          state.energy = Math.min(state.energyMax, state.energy + 5);
          if (state.energy >= state.energyMax) state.energyTimerMs = 0;
        }
      },
      {
        id: 'credit_boost_run',
        name: 'í¬ë ˆë”§ ë©€í‹°í”Œë¼ì´ì–´ (ì„¸ì…˜)',
        desc: 'í˜„ì¬ ì„¸ì…˜ ë™ì•ˆ í•´í‚¹ ì„±ê³µ ì‹œ í¬ë ˆë”§ 1.5ë°°.',
        cost: 700,
        rarity: 'RARE',
        category: 'ECONOMY',
        buy: () => {
          modifiers.creditMultiplierSession = 1.5;
        }
      },
      {
        id: 'max_energy_up',
        name: 'ì—ë„ˆì§€ ìµœëŒ€ì¹˜ ì—…ê·¸ë ˆì´ë“œ',
        desc: 'ìµœëŒ€ ì—ë„ˆì§€ +5 (ì˜êµ¬).',
        cost: 1200,
        rarity: 'RARE',
        category: 'ENERGY',
        buy: () => {
          state.energyMax += 5;
          if (state.energy >= state.energyMax) state.energyTimerMs = 0;
        }
      },
      {
        id: 'scanner_module',
        name: 'ê³ ê¸‰ ìŠ¤ìºë„ˆ ëª¨ë“ˆ',
        desc: 'ì½”ë“œ ìŠ¤ìº” ì‹œ ê²½í—˜ì¹˜ +2 ì¶”ê°€.',
        cost: 350,
        rarity: 'UNCOMMON',
        category: 'SYSTEM',
        buy: () => {
          modifiers.scanExtraExp += 2;
        }
      },
      {
        id: 'energy_boost_2',
        name: 'ì—ë„ˆì§€ ë¶€ìŠ¤í„° II',
        desc: 'ì¦‰ì‹œ ì—ë„ˆì§€ +10.',
        cost: 320,
        rarity: 'UNCOMMON',
        category: 'ENERGY',
        buy: () => {
          state.energy = Math.min(state.energyMax, state.energy + 10);
          if (state.energy >= state.energyMax) state.energyTimerMs = 0;
        }
      },
      {
        id: 'exp_boost',
        name: 'ê²½í—˜ì¹˜ ì¦í­ê¸°',
        desc: 'ê²½í—˜ì¹˜ íšë“ëŸ‰ 20% ì¦ê°€ (ì˜êµ¬).',
        cost: 800,
        rarity: 'RARE',
        category: 'SYSTEM',
        buy: () => {
          modifiers.expMultiplier += 0.2;
        }
      },
      {
        id: 'cpu_discount',
        name: 'CPU ì—…ê·¸ë ˆì´ë“œ ì¿ í°',
        desc: 'CPU ì—…ê·¸ë ˆì´ë“œ ë¹„ìš© 10% í• ì¸ (ì¤‘ì²©).',
        cost: 900,
        rarity: 'RARE',
        category: 'SYSTEM',
        buy: () => {
          modifiers.cpuUpgradeDiscount *= 0.9;
          if (modifiers.cpuUpgradeDiscount < 0.5) {
            modifiers.cpuUpgradeDiscount = 0.5;
          }
        }
      },
      {
        id: 'perm_credit_boost',
        name: 'ì˜êµ¬ í¬ë ˆë”§ ë©€í‹°í”Œë¼ì´ì–´',
        desc: 'í•´í‚¹ í¬ë ˆë”§ ë³´ìƒ 15% ì¦ê°€ (ì˜êµ¬, ì¤‘ì²©).',
        cost: 1500,
        rarity: 'EPIC',
        category: 'ECONOMY',
        buy: () => {
          modifiers.creditMultiplierPermanent *= 1.15;
        }
      },
      {
        id: 'risk_support',
        name: 'ìœ„í—˜ í•´í‚¹ ì„œí¬í„°',
        desc: 'ìœ„í—˜ í•´í‚¹ ëª¨ë“œ ì„±ê³µ í™•ë¥  +5%p (ì˜êµ¬, ì¤‘ì²©).',
        cost: 950,
        rarity: 'RARE',
        category: 'UTILITY',
        buy: () => {
          modifiers.riskSuccessBonus += 0.05;
        }
      },
      {
        id: 'big_credit_pack',
        name: 'ë°ì´í„° í¬ë ˆë”§ íŒ©',
        desc: 'ì¦‰ì‹œ í¬ë ˆë”§ +500.',
        cost: 400,
        rarity: 'COMMON',
        category: 'ECONOMY',
        buy: () => {
          state.credits += 500;
          state.stats.creditsEarnedTotal += 500;
        }
      },
      {
        id: 'scanner_plus',
        name: 'ì •ë°€ ìŠ¤ìºë„ˆ',
        desc: 'ì½”ë“œ ìŠ¤ìº” ì‹œ ì¶”ê°€ ê²½í—˜ì¹˜ +1 (ì˜êµ¬, ì¤‘ì²©).',
        cost: 450,
        rarity: 'UNCOMMON',
        category: 'SYSTEM',
        buy: () => {
          modifiers.scanExtraExp += 1;
        }
      },
      {
        id: 'level_ticket',
        name: 'ì‹œë®¬ë ˆì´ì…˜ ë ˆë²¨ í‹°ì¼“',
        desc: 'ì¦‰ì‹œ ë ˆë²¨ 1íšŒ ìƒìŠ¹.',
        cost: 1000,
        rarity: 'EPIC',
        category: 'UTILITY',
        buy: () => {
          levelUp();
        }
      }
    ];

    // ìƒì /ê²½í—˜ì¹˜ ê³„ìˆ˜
    const modifiers = {
      creditMultiplierSession: 1.0,
      scanExtraExp: 0,
      creditMultiplierPermanent: 1.0,
      expMultiplier: 1.0,
      cpuUpgradeDiscount: 1.0,
      riskSuccessBonus: 0.0
    };

    // ë¯¸ì…˜ ì •ì˜
    const missionDefs = {
      daily: [
        { id: 'daily_scan5',   name: 'ì¼ì¼ ìŠ¤ìºë„ˆ I',     type: 'scans',         target: 5,   rewardCredits: 50,  desc: 'ì½”ë“œ ìŠ¤ìº” 5íšŒ ìˆ˜í–‰' },
        { id: 'daily_scan10',  name: 'ì¼ì¼ ìŠ¤ìºë„ˆ II',    type: 'scans',         target: 10,  rewardCredits: 80,  desc: 'ì½”ë“œ ìŠ¤ìº” 10íšŒ ìˆ˜í–‰' },
        { id: 'daily_hack3',   name: 'ì¼ì¼ ì¹¨ì…ì I',     type: 'hackSuccess',   target: 3,   rewardCredits: 80,  desc: 'ì„œë²„ í•´í‚¹ ì„±ê³µ 3íšŒ' },
        { id: 'daily_hack5',   name: 'ì¼ì¼ ì¹¨ì…ì II',    type: 'hackSuccess',   target: 5,   rewardCredits: 100, desc: 'ì„œë²„ í•´í‚¹ ì„±ê³µ 5íšŒ' },
        { id: 'daily_energy30',name: 'ì—ë„ˆì§€ ì†Œë¹„ì',      type: 'energySpent',   target: 30,  rewardCredits: 70,  desc: 'ì—ë„ˆì§€ 30 ì†Œëª¨í•˜ê¸°' },
        { id: 'daily_action10_pack', name: 'ë³´ê¸‰ ë£¨í‹´',    type: 'actions',       target: 10,  rewardCredits: 60,  rewardEnergyPack: 1, desc: 'ì½”ë“œ ìŠ¤ìº”/ì„œë²„ í•´í‚¹ ì´ 10íšŒ ìˆ˜í–‰' }
      ],
      weekly: [
        { id: 'weekly_scan30',   name: 'ì£¼ê°„ ìŠ¤ìºë„ˆ',        type: 'scans',       target: 30,  rewardCredits: 120, desc: 'ì½”ë“œ ìŠ¤ìº” 30íšŒ ìˆ˜í–‰' },
        { id: 'weekly_scan50',   name: 'ì§‘ìš”í•œ ìŠ¤ìºë„ˆ',      type: 'scans',       target: 50,  rewardCredits: 180, desc: 'ì½”ë“œ ìŠ¤ìº” 50íšŒ ìˆ˜í–‰' },
        { id: 'weekly_hack20',   name: 'ì£¼ê°„ ì¹¨ì…ì',        type: 'hackSuccess', target: 20,  rewardCredits: 200, desc: 'ì„œë²„ í•´í‚¹ ì„±ê³µ 20íšŒ' },
        { id: 'weekly_energy100',name: 'ì—ë„ˆì§€ ì†Œëª¨ì™•',       type: 'energySpent', target: 100, rewardCredits: 200, desc: 'ì—ë„ˆì§€ 100 ì†Œëª¨í•˜ê¸°' },
        { id: 'weekly_level10',  name: 'ì£¼ê°„ ì„±ì¥',          type: 'level',       target: 10,  rewardCredits: 250, desc: 'í”Œë ˆì´ì–´ ë ˆë²¨ 10 ë‹¬ì„±' }
      ],
      month: [
        { id: 'month_scan100',     name: 'ì›”ê°„ ìŠ¤ìºë„ˆ',        type: 'scans',           target: 100, rewardCredits: 300, desc: 'ì½”ë“œ ìŠ¤ìº” 100íšŒ ìˆ˜í–‰' },
        { id: 'month_scan200',     name: 'ê´‘ì ì¸ ë¶„ì„ê°€',      type: 'scans',           target: 200, rewardCredits: 500, desc: 'ì½”ë“œ ìŠ¤ìº” 200íšŒ ìˆ˜í–‰' },
        { id: 'month_hack50',      name: 'ì›”ê°„ ì¹¨ì…ì',        type: 'hackSuccess',     target: 50,  rewardCredits: 400, desc: 'ì„œë²„ í•´í‚¹ ì„±ê³µ 50íšŒ' },
        { id: 'month_energy300',   name: 'ì—ë„ˆì§€ ë¸Œë ˆì´ì»¤',     type: 'energySpent',     target: 300, rewardCredits: 450, desc: 'ì—ë„ˆì§€ 300 ì†Œëª¨í•˜ê¸°' },
        { id: 'month_level15',     name: 'ì›”ê°„ ì„±ì¥',          type: 'level',           target: 15,  rewardCredits: 500, desc: 'í”Œë ˆì´ì–´ ë ˆë²¨ 15 ë‹¬ì„±' },
        { id: 'month_scan_risk',   name: 'ìœ„í—˜í•œ ë¶„ì„',        type: 'riskHackSuccess', target: 30,  rewardCredits: 500, desc: 'ìœ„í—˜ í•´í‚¹ ëª¨ë“œë¡œ ì„œë²„ í•´í‚¹ ì„±ê³µ 30íšŒ' },
        { id: 'month_energy0',     name: 'í•œê³„ ëŒíŒŒ',          type: 'energy0Flag',     target: 1,   rewardCredits: 350, desc: 'í•œ ë‹¬ ë™ì•ˆ ìµœì†Œ 1íšŒ ì—ë„ˆì§€ë¥¼ 0ê¹Œì§€ ì†Œëª¨' }
      ],
      // GENERAL: ì¥ê¸° ê³¼ì œ ~30ê°œ
      general: [
        { id: 'gen_scan_20',       name: 'ë¶„ì„ ì…ë¬¸',           type: 'scans',             target: 20,   rewardCredits: 60,   desc: 'ëˆ„ì  ì½”ë“œ ìŠ¤ìº” 20íšŒ' },
        { id: 'gen_scan_50',       name: 'ë¶„ì„ê°€ I',           type: 'scans',             target: 50,   rewardCredits: 120,  desc: 'ëˆ„ì  ì½”ë“œ ìŠ¤ìº” 50íšŒ' },
        { id: 'gen_scan_100',      name: 'ë¶„ì„ê°€ II',          type: 'scans',             target: 100,  rewardCredits: 200,  desc: 'ëˆ„ì  ì½”ë“œ ìŠ¤ìº” 100íšŒ' },
        { id: 'gen_scan_200',      name: 'ë°ì´í„° ì¤‘ë…',         type: 'scans',             target: 200,  rewardCredits: 350,  desc: 'ëˆ„ì  ì½”ë“œ ìŠ¤ìº” 200íšŒ' },
        { id: 'gen_scan_300',      name: 'ë°ì´í„° ê´‘ì‹ ë„',       type: 'scans',             target: 300,  rewardCredits: 500,  desc: 'ëˆ„ì  ì½”ë“œ ìŠ¤ìº” 300íšŒ' },

        { id: 'gen_hack_20',       name: 'ì¹¨ì… ì „ë¬¸ê°€ I',        type: 'hackSuccess',       target: 20,   rewardCredits: 150,  desc: 'ëˆ„ì  í•´í‚¹ ì„±ê³µ 20íšŒ' },
        { id: 'gen_hack_50',       name: 'ì¹¨ì… ì „ë¬¸ê°€ II',       type: 'hackSuccess',       target: 50,   rewardCredits: 250,  desc: 'ëˆ„ì  í•´í‚¹ ì„±ê³µ 50íšŒ' },
        { id: 'gen_hack_100',      name: 'ì¹¨ì… ë§ˆìŠ¤í„°',         type: 'hackSuccess',       target: 100,  rewardCredits: 500,  desc: 'ëˆ„ì  í•´í‚¹ ì„±ê³µ 100íšŒ' },

        { id: 'gen_energy_spent_200', name: 'ì—ë„ˆì§€ ë¶„í•´ I',    type: 'energySpentTotal',  target: 200,  rewardCredits: 200,  desc: 'ëˆ„ì  ì—ë„ˆì§€ 200 ì†Œëª¨' },
        { id: 'gen_energy_spent_500', name: 'ì—ë„ˆì§€ ë¶„í•´ II',   type: 'energySpentTotal',  target: 500,  rewardCredits: 400,  desc: 'ëˆ„ì  ì—ë„ˆì§€ 500 ì†Œëª¨' },
        { id: 'gen_energy_spent_1000',name: 'ì—ë„ˆì§€ ë¸Œë£¨íƒˆ',    type: 'energySpentTotal',  target: 1000, rewardCredits: 700,  desc: 'ëˆ„ì  ì—ë„ˆì§€ 1000 ì†Œëª¨' },

        { id: 'gen_level_5',       name: 'ì„±ì¥ ê´€ì°°',           type: 'level',             target: 5,    rewardCredits: 120,  desc: 'í”Œë ˆì´ì–´ ë ˆë²¨ 5 ë‹¬ì„±' },
        { id: 'gen_level_10',      name: 'ì„±ì¥ ê°€ì†',           type: 'level',             target: 10,   rewardCredits: 200,  desc: 'í”Œë ˆì´ì–´ ë ˆë²¨ 10 ë‹¬ì„±' },
        { id: 'gen_level_15',      name: 'ì„±ì¥ í­ì£¼',           type: 'level',             target: 15,   rewardCredits: 350,  desc: 'í”Œë ˆì´ì–´ ë ˆë²¨ 15 ë‹¬ì„±' },
        { id: 'gen_level_20',      name: 'ê³ ê¸‰ ìš´ì˜ì',         type: 'level',             target: 20,   rewardCredits: 600,  desc: 'í”Œë ˆì´ì–´ ë ˆë²¨ 20 ë‹¬ì„±' },

        { id: 'gen_cpu_3',         name: 'CPU íŠœë„ˆ I',          type: 'cpuTier',           target: 3,    rewardCredits: 200,  desc: 'CPU í‹°ì–´ 3 ë‹¬ì„±' },
        { id: 'gen_cpu_5',         name: 'CPU íŠœë„ˆ II',         type: 'cpuTier',           target: 5,    rewardCredits: 400,  desc: 'CPU í‹°ì–´ 5 ë‹¬ì„±' },

        { id: 'gen_energyMax_20',  name: 'ì—ë„ˆì§€ ë²„í¼ I',       type: 'energyMax',         target: 20,   rewardCredits: 250,  desc: 'ì—ë„ˆì§€ ìµœëŒ€ì¹˜ 20 ë‹¬ì„±' },
        { id: 'gen_energyMax_25',  name: 'ì—ë„ˆì§€ ë²„í¼ II',      type: 'energyMax',         target: 25,   rewardCredits: 400,  desc: 'ì—ë„ˆì§€ ìµœëŒ€ì¹˜ 25 ë‹¬ì„±' },
        { id: 'gen_energyMax_30',  name: 'ì—ë„ˆì§€ ì €ì¥ê³ ',       type: 'energyMax',         target: 30,   rewardCredits: 600,  desc: 'ì—ë„ˆì§€ ìµœëŒ€ì¹˜ 30 ë‹¬ì„±' },

        { id: 'gen_shop_5',        name: 'ì‡¼í•‘ ì• í˜¸ê°€ I',        type: 'shopPurchases',     target: 5,    rewardCredits: 150,  desc: 'ìƒì ì—ì„œ ëˆ„ì  5íšŒ êµ¬ë§¤' },
        { id: 'gen_shop_15',       name: 'ì‡¼í•‘ ì• í˜¸ê°€ II',       type: 'shopPurchases',     target: 15,   rewardCredits: 300,  desc: 'ìƒì ì—ì„œ ëˆ„ì  15íšŒ êµ¬ë§¤' },
        { id: 'gen_shop_30',       name: 'ì‡¼í•‘ ë§¤ë‹ˆì•„',          type: 'shopPurchases',     target: 30,   rewardCredits: 500,  desc: 'ìƒì ì—ì„œ ëˆ„ì  30íšŒ êµ¬ë§¤' },

        { id: 'gen_credits_5000',  name: 'ë°ì´í„° ìë³¸ê°€ I',      type: 'creditsEarnedTotal',target: 5000, rewardCredits: 300,  desc: 'ëˆ„ì  íšë“ í¬ë ˆë”§ 5000 ë‹¬ì„±' },
        { id: 'gen_credits_20000', name: 'ë°ì´í„° ìë³¸ê°€ II',     type: 'creditsEarnedTotal',target: 20000,rewardCredits: 600,  desc: 'ëˆ„ì  íšë“ í¬ë ˆë”§ 20000 ë‹¬ì„±' },

        { id: 'gen_achieve_5',     name: 'ê¸°ë¡ ìˆ˜ì§‘ê°€ I',        type: 'achievements',      target: 5,    rewardCredits: 200,  desc: 'ì—…ì  5ê°œ ë‹¬ì„±' },
        { id: 'gen_achieve_10',    name: 'ê¸°ë¡ ìˆ˜ì§‘ê°€ II',       type: 'achievements',      target: 10,   rewardCredits: 350,  desc: 'ì—…ì  10ê°œ ë‹¬ì„±' },
        { id: 'gen_achieve_15',    name: 'ê¸°ë¡ ìˆ˜ì§‘ê°€ III',      type: 'achievements',      target: 15,   rewardCredits: 500,  desc: 'ì—…ì  15ê°œ ë‹¬ì„±' },

        { id: 'gen_mission_10',    name: 'í€˜ìŠ¤íŠ¸ ëŸ¬ë„ˆ',          type: 'missionsCompleted', target: 10,   rewardCredits: 300,  desc: 'ëˆ„ì  í€˜ìŠ¤íŠ¸ 10ê°œ ì™„ë£Œ' },
        { id: 'gen_mission_25',    name: 'í€˜ìŠ¤íŠ¸ í—Œí„°',          type: 'missionsCompleted', target: 25,   rewardCredits: 500,  desc: 'ëˆ„ì  í€˜ìŠ¤íŠ¸ 25ê°œ ì™„ë£Œ' },
        { id: 'gen_mission_40',    name: 'í€˜ìŠ¤íŠ¸ ë§¤ë‹ˆì•…',        type: 'missionsCompleted', target: 40,   rewardCredits: 800,  desc: 'ëˆ„ì  í€˜ìŠ¤íŠ¸ 40ê°œ ì™„ë£Œ' },

        { id: 'gen_risk_10',       name: 'ìœ„í—˜ ì¹œí™” I',          type: 'riskHackSuccess',   target: 10,   rewardCredits: 400,  desc: 'ìœ„í—˜ í•´í‚¹ ëª¨ë“œë¡œ í•´í‚¹ ì„±ê³µ 10íšŒ' },
        { id: 'gen_risk_25',       name: 'ìœ„í—˜ ì¹œí™” II',         type: 'riskHackSuccess',   target: 25,   rewardCredits: 700,  desc: 'ìœ„í—˜ í•´í‚¹ ëª¨ë“œë¡œ í•´í‚¹ ì„±ê³µ 25íšŒ' },


        // v1.7.x ì¶”ê°€ GENERAL (Trace/ë¡œê·¸ ì¶•)
        { id: 'gen_trace_reduce_10', name: 'ì¶”ì  ì§„ì • I', type: 'traceReduced', target: 10, rewardCredits: 150, desc: 'Traceë¥¼ ëˆ„ì  10 ê°ì†Œì‹œí‚¤ê¸°' },
        { id: 'gen_trace_reduce_30', name: 'ì¶”ì  ì§„ì • II', type: 'traceReduced', target: 30, rewardCredits: 350, desc: 'Traceë¥¼ ëˆ„ì  30 ê°ì†Œì‹œí‚¤ê¸°' },
        { id: 'gen_trace_zero_5', name: 'í”ì  ì‚­ì œ', type: 'traceZeroCount', target: 5, rewardCredits: 250, desc: 'Trace 0% ë‹¬ì„± 5íšŒ' },
        { id: 'gen_stealth_hack_10', name: 'ì ì… ì„±ê³µ I', type: 'stealthHackSuccess', target: 10, rewardCredits: 300, desc: 'Trace 25% ì´í•˜ì—ì„œ í•´í‚¹ ì„±ê³µ 10íšŒ' },
        { id: 'gen_stealth_hack_25', name: 'ì ì… ì„±ê³µ II', type: 'stealthHackSuccess', target: 25, rewardCredits: 600, desc: 'Trace 25% ì´í•˜ì—ì„œ í•´í‚¹ ì„±ê³µ 25íšŒ' },
        { id: 'gen_hightrace_hack_5', name: 'ê³ ìœ„í—˜ ê³ ìˆ˜ìµ I', type: 'highTraceHackSuccess', target: 5, rewardCredits: 350, desc: 'Trace 75% ì´ìƒì—ì„œ í•´í‚¹ ì„±ê³µ 5íšŒ' },
        { id: 'gen_hightrace_hack_15', name: 'ê³ ìœ„í—˜ ê³ ìˆ˜ìµ II', type: 'highTraceHackSuccess', target: 15, rewardCredits: 800, desc: 'Trace 75% ì´ìƒì—ì„œ í•´í‚¹ ì„±ê³µ 15íšŒ' },
        { id: 'gen_lock_survivor', name: 'ë½ë‹¤ìš´ ìƒì¡´ì', type: 'postLockSuccess', target: 1, rewardCredits: 500, desc: 'Trace LOCK ë°œìƒ ì´í›„ ì²« í•´í‚¹ ì„±ê³µ' },
        { id: 'gen_logs_200', name: 'ë¡œê·¸ ì±„êµ´ I', type: 'logsCreated', target: 200, rewardCredits: 200, desc: 'ë¡œê·¸ 200ì¤„ ìƒì„±' },
        { id: 'gen_logs_600', name: 'ë¡œê·¸ ì±„êµ´ II', type: 'logsCreated', target: 600, rewardCredits: 500, desc: 'ë¡œê·¸ 600ì¤„ ìƒì„±' }
      ]
    ,
      stage: [
        { id: 'stage_01', name: 'STAGE 1: ì²« ë¶„ì„', type: 'scans', target: 10, rewardCredits: 30, desc: 'ëˆ„ì  ì½”ë“œ ìŠ¤ìº” 10íšŒ', stage: 1 },
        { id: 'stage_02', name: 'STAGE 2: ì²« ì¹¨ì…', type: 'hackSuccess', target: 3, rewardCredits: 35, desc: 'ëˆ„ì  í•´í‚¹ ì„±ê³µ 3íšŒ', stage: 2, requires: 'stage_01' },
        { id: 'stage_03', name: 'STAGE 3: ì—ë„ˆì§€ ì†Œëª¨', type: 'energySpentTotal', target: 50, rewardCredits: 40, desc: 'ëˆ„ì  ì—ë„ˆì§€ 50 ì†Œëª¨', stage: 3, requires: 'stage_02' },
        { id: 'stage_04', name: 'STAGE 4: ë¶„ì„ ìŠµê´€', type: 'scans', target: 30, rewardCredits: 45, desc: 'ëˆ„ì  ì½”ë“œ ìŠ¤ìº” 30íšŒ', stage: 4, requires: 'stage_03' },
        { id: 'stage_05', name: 'STAGE 5: ì¹¨ì… ë£¨í‹´', type: 'hackSuccess', target: 10, rewardCredits: 55, desc: 'ëˆ„ì  í•´í‚¹ ì„±ê³µ 10íšŒ', stage: 5, requires: 'stage_04' },
        { id: 'stage_06', name: 'STAGE 6: í”ì  ê´€ë¦¬', type: 'traceReduced', target: 5, rewardCredits: 60, desc: 'Trace ê°ì†Œ 5íšŒ ë‹¬ì„±', stage: 6, requires: 'stage_05' },
        { id: 'stage_07', name: 'STAGE 7: ì„±ì¥ ì‹œì‘', type: 'level', target: 5, rewardCredits: 70, desc: 'í”Œë ˆì´ì–´ ë ˆë²¨ 5 ë‹¬ì„±', stage: 7, requires: 'stage_06' },
        { id: 'stage_08', name: 'STAGE 8: CPU íŠœë‹', type: 'cpuTier', target: 3, rewardCredits: 80, desc: 'CPU í‹°ì–´ 3 ë‹¬ì„±', stage: 8, requires: 'stage_07' },
        { id: 'stage_09', name: 'STAGE 9: ì²« ì†Œë¹„', type: 'shopPurchases', target: 5, rewardCredits: 80, desc: 'ìƒì  ëˆ„ì  5íšŒ êµ¬ë§¤', stage: 9, requires: 'stage_08' },
        { id: 'stage_10', name: 'STAGE 10: ì™„ì „ ì‚­ì œ', type: 'traceZeroCount', target: 1, rewardCredits: 90, desc: 'Trace 0% ë‹¬ì„± 1íšŒ', stage: 10, requires: 'stage_09' },
        { id: 'stage_11', name: 'STAGE 11: ì ì…ì', type: 'stealthHackSuccess', target: 5, rewardCredits: 100, desc: 'Trace 25% ì´í•˜ í•´í‚¹ ì„±ê³µ 5íšŒ', stage: 11, requires: 'stage_10' },
        { id: 'stage_12', name: 'STAGE 12: ê³ ìœ„í—˜', type: 'highTraceHackSuccess', target: 3, rewardCredits: 110, desc: 'Trace 75% ì´ìƒ í•´í‚¹ ì„±ê³µ 3íšŒ', stage: 12, requires: 'stage_11' },
        { id: 'stage_13', name: 'STAGE 13: ë°ì´í„° ìë³¸', type: 'creditsEarnedTotal', target: 10000, rewardCredits: 120, desc: 'ëˆ„ì  íšë“ í¬ë ˆë”§ 10,000 ë‹¬ì„±', stage: 13, requires: 'stage_12' },
        { id: 'stage_14', name: 'STAGE 14: ìˆ™ë ¨ ìš´ì˜ì', type: 'level', target: 10, rewardCredits: 130, desc: 'í”Œë ˆì´ì–´ ë ˆë²¨ 10 ë‹¬ì„±', stage: 14, requires: 'stage_13' },
        { id: 'stage_15', name: 'STAGE 15: ì¥ë¹„ í™•ì¥', type: 'energyMax', target: 25, rewardCredits: 140, desc: 'ì—ë„ˆì§€ ìµœëŒ€ì¹˜ 25 ë‹¬ì„±', stage: 15, requires: 'stage_14' },
        { id: 'stage_16', name: 'STAGE 16: ì§‘ìš”í•¨', type: 'hackSuccess', target: 25, rewardCredits: 160, desc: 'ëˆ„ì  í•´í‚¹ ì„±ê³µ 25íšŒ', stage: 16, requires: 'stage_15' },
        { id: 'stage_17', name: 'STAGE 17: ê¸°ë¡ ì±„êµ´', type: 'logsCreated', target: 300, rewardCredits: 170, desc: 'ë¡œê·¸ 300ì¤„ ìƒì„±', stage: 17, requires: 'stage_16' },
        { id: 'stage_18', name: 'STAGE 18: ë½ë‹¤ìš´ ìƒì¡´', type: 'postLockSuccess', target: 1, rewardCredits: 200, desc: 'Trace LOCK ì´í›„ ì²« ì„±ê³µ 1íšŒ', stage: 18, requires: 'stage_17' },
        { id: 'stage_19', name: 'STAGE 19: ìœ„í—˜ ì¹œí™”', type: 'riskHackSuccess', target: 5, rewardCredits: 220, desc: 'ìœ„í—˜ í•´í‚¹ ëª¨ë“œ ì„±ê³µ 5íšŒ', stage: 19, requires: 'stage_18' },
        { id: 'stage_20', name: 'STAGE 20: ë§ˆìŠ¤í„° í´ë˜ìŠ¤', type: 'level', target: 15, rewardCredits: 300, desc: 'í”Œë ˆì´ì–´ ë ˆë²¨ 15 ë‹¬ì„±', stage: 20, requires: 'stage_19' },
      ]
    };

    // ì—…ì  ì •ì˜ (í™•ì¥)
    const achievementDefs = [
      // EASY
      { id: 'first_hack_success',   name: 'ì²« ì¹¨ì…',           desc: 'ì²˜ìŒìœ¼ë¡œ ì„œë²„ í•´í‚¹ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.',         difficulty: 'easy',   hidden: false },
      { id: 'reach_level3',         name: 'ì´ˆë³´ í•´ì»¤',         desc: 'í”Œë ˆì´ì–´ ë ˆë²¨ 3ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.',             difficulty: 'easy',   hidden: false },
      { id: 'scan_10',              name: 'ìŠ¤ìºë„ˆ ì…ë¬¸',       desc: 'ì½”ë“œ ìŠ¤ìº”ì„ 10íšŒ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.',              difficulty: 'easy',   hidden: false },
      { id: 'shop_first_buy',       name: 'ì²« ì‡¼í•‘',           desc: 'ìƒì ì—ì„œ ì²˜ìŒìœ¼ë¡œ ì•„ì´í…œì„ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤.',     difficulty: 'easy',   hidden: true  },
      { id: 'energy_zero',          name: 'ê¸°ì§„ë§¥ì§„',          desc: 'ì—ë„ˆì§€ë¥¼ 0ê¹Œì§€ ëª¨ë‘ ì†Œëª¨í–ˆìŠµë‹ˆë‹¤.',           difficulty: 'easy',   hidden: true  },
      { id: 'collector_beginner',   name: 'ì½”ë“œ ì½œë ‰í„° I',     desc: 'ì„œë¡œ ë‹¤ë¥¸ ì½”ë“œë¥¼ 3ê°œ ì´ìƒ ë³´ìœ í–ˆìŠµë‹ˆë‹¤.',      difficulty: 'easy',   hidden: false },
      { id: 'daily_mission_clear1', name: 'ë°ì¼ë¦¬ ìŠ¤íƒ€í„°',     desc: 'ë°ì¼ë¦¬ í€˜ìŠ¤íŠ¸ë¥¼ 1ê°œ ì´ìƒ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.',       difficulty: 'easy',   hidden: false },
      { id: 'scan_30',              name: 'ìŠ¤ìºë„ˆ ìˆ™ë ¨',       desc: 'ì½”ë“œ ìŠ¤ìº”ì„ 30íšŒ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.',              difficulty: 'easy',   hidden: false },
      { id: 'get_epic_code',        name: 'ê³ ê¸‰ ì½”ë“œ í™•ë³´',     desc: 'EPIC ì´ìƒ ë“±ê¸‰ì˜ ì½”ë“œë¥¼ ì²˜ìŒ íšë“í–ˆìŠµë‹ˆë‹¤.',   difficulty: 'easy',   hidden: false },

      // NORMAL
      { id: 'reach_level10',        name: 'ì¤‘ê¸‰ í•´ì»¤',         desc: 'í”Œë ˆì´ì–´ ë ˆë²¨ 10ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.',             difficulty: 'normal', hidden: false },
      { id: 'scan_50',              name: 'ë°ì´í„° ê´‘',         desc: 'ì½”ë“œ ìŠ¤ìº”ì„ 50íšŒ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.',              difficulty: 'normal', hidden: true  },
      { id: 'hack_30_success',      name: 'ì„±ê³µì ì¸ ì¹¨ì…ì',    desc: 'ì„œë²„ í•´í‚¹ì— 30íšŒ ì´ìƒ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.',         difficulty: 'normal', hidden: false },
      { id: 'weekly_mission_clear1',name: 'ì£¼ê°„ ë£¨í‹´',         desc: 'ìœ„í´ë¦¬ í€˜ìŠ¤íŠ¸ë¥¼ 1ê°œ ì´ìƒ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.',       difficulty: 'normal', hidden: false },
      { id: 'energy_max_25',        name: 'ì§€ì† ê°€ëŠ¥í•œ ì—ë„ˆì§€', desc: 'ì—ë„ˆì§€ ìµœëŒ€ì¹˜ë¥¼ 25 ì´ìƒìœ¼ë¡œ í™•ì¥í–ˆìŠµë‹ˆë‹¤.',   difficulty: 'normal', hidden: true  },
      { id: 'credits_5000',         name: 'ë°ì´í„° ìë³¸ê°€ I',   desc: 'ëˆ„ì  íšë“ í¬ë ˆë”§ 5000ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.',        difficulty: 'normal', hidden: false },
      { id: 'mission_10',           name: 'í€˜ìŠ¤íŠ¸ ëŸ¬ë„ˆ',       desc: 'ëˆ„ì  í€˜ìŠ¤íŠ¸ 10ê°œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.',             difficulty: 'normal', hidden: false },

      // HARD
      { id: 'cpu_tier_5',           name: 'ì˜¤ë²„í´ëŸ¬ì»¤',        desc: 'CPU í‹°ì–´ë¥¼ 5 ì´ìƒìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí–ˆìŠµë‹ˆë‹¤.',   difficulty: 'hard',   hidden: true  },
      { id: 'month_mission_all',    name: 'ì›”ê°„ ë§ˆìŠ¤í„°',       desc: 'í•œ ë‹¬ ë™ì•ˆ ëª¨ë“  MONTH QUESTë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.', difficulty: 'hard',   hidden: true  },
      { id: 'credits_20000',        name: 'ë°ì´í„° ìë³¸ê°€ II',  desc: 'ëˆ„ì  íšë“ í¬ë ˆë”§ 20000ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.',       difficulty: 'hard',   hidden: true  },
      { id: 'risk_10_success',      name: 'ìœ„í—˜í•œ ìŠ¹ë¶€ì‚¬',     desc: 'ìœ„í—˜ í•´í‚¹ ëª¨ë“œë¡œ í•´í‚¹ ì„±ê³µ 10íšŒë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.',difficulty: 'hard',  hidden: true  },


      // v1.7.x ì¶”ê°€ ì—…ì  (ì¼ë°˜ 12 + íˆë“  8)
      { id: 'trace_reduce_25', name: 'TRACE AWARE', desc: 'Trace ê°ì†Œë¥¼ ëˆ„ì  25 ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.', difficulty: 'easy', hidden: false },
      { id: 'trace_zero_10', name: 'COOL HEAD', desc: 'Trace 0%ë¥¼ 10íšŒ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.', difficulty: 'normal', hidden: false },
      { id: 'stealth_breacher_20', name: 'SHADOW BREACHER', desc: 'Trace 25% ì´í•˜ì—ì„œ í•´í‚¹ ì„±ê³µ 20íšŒë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.', difficulty: 'normal', hidden: false },
      { id: 'high_risk_20', name: 'HIGH RISK', desc: 'Trace 75% ì´ìƒì—ì„œ í•´í‚¹ ì„±ê³µ 20íšŒë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.', difficulty: 'hard', hidden: false },
      { id: 'lockdown_3', name: 'LOCKDOWN SURVIVOR', desc: 'Trace LOCKì„ 3íšŒ ê²½í—˜í–ˆìŠµë‹ˆë‹¤.', difficulty: 'normal', hidden: false },
      { id: 'comeback_1', name: 'COMEBACK', desc: 'ì—°ì† ì‹¤íŒ¨ 3íšŒ í›„ ë‹¤ìŒ ì‹œë„ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.', difficulty: 'hard', hidden: false },
      { id: 'streak_3', name: 'STREAKER I', desc: 'ì—°ì† ì„±ê³µ 3íšŒë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.', difficulty: 'easy', hidden: false },
      { id: 'streak_7', name: 'STREAKER II', desc: 'ì—°ì† ì„±ê³µ 7íšŒë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.', difficulty: 'hard', hidden: false },
      { id: 'log_addict_500', name: 'LOG ADDICT', desc: 'ë¡œê·¸ë¥¼ 500ì¤„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.', difficulty: 'easy', hidden: false },
      { id: 'log_archivist_1500', name: 'LOG ARCHIVIST', desc: 'ë¡œê·¸ë¥¼ 1500ì¤„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.', difficulty: 'hard', hidden: false },
      { id: 'market_regular_50', name: 'MARKET REGULAR', desc: 'ìƒì ì—ì„œ 50íšŒ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤.', difficulty: 'normal', hidden: false },
      { id: 'credits_50000', name: 'DATA MAGNATE III', desc: 'ëˆ„ì  íšë“ í¬ë ˆë”§ 50000ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.', difficulty: 'hard', hidden: false },
      { id: 'hidden_trace95', name: 'YOU WERE WATCHED', desc: 'Trace 95%ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.', difficulty: 'hard', hidden: true },
      { id: 'hidden_lock_attempt', name: 'THEY KNOW', desc: 'Trace LOCK ìƒíƒœì—ì„œ í–‰ë™ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤.', difficulty: 'normal', hidden: true },
      { id: 'hidden_last_second', name: 'LAST SECOND', desc: 'Trace 90% ì´ìƒì—ì„œ í•´í‚¹ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.', difficulty: 'hard', hidden: true },
      { id: 'hidden_ghost3', name: 'GHOST', desc: 'Trace 0% ìƒíƒœì—ì„œ í•´í‚¹ì— 3íšŒ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.', difficulty: 'hard', hidden: true },
      { id: 'hidden_same_action_20', name: 'SYSTEM ANOMALY', desc: 'ê°™ì€ í–‰ë™ì„ 20íšŒ ì—°ì† ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.', difficulty: 'normal', hidden: true },
      { id: 'hidden_energy0_attempt', name: 'BLACKOUT', desc: 'ì—ë„ˆì§€ 0 ìƒíƒœì—ì„œ í–‰ë™ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤.', difficulty: 'easy', hidden: true },
      { id: 'hidden_no_fail_5min', name: 'SILENT NIGHT', desc: '5ë¶„ ë™ì•ˆ ê²½ê³ /ì‹¤íŒ¨ ë¡œê·¸ ì—†ì´ ë¡œê·¸ë¥¼ ìœ ì§€í–ˆìŠµë‹ˆë‹¤.', difficulty: 'hard', hidden: true },
      { id: 'hidden_lock_and_clear', name: 'CLOSE CALL', desc: 'Trace LOCK ì´í›„ ì²« í•´í‚¹ ì„±ê³µì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.', difficulty: 'hard', hidden: true }
    ];

    // DOM
    const statLevel = document.getElementById('statLevel');
    const statExp = document.getElementById('statExp');
    const statCredits = document.getElementById('statCredits');
    const statCpuTier = document.getElementById('statCpuTier');
    const statEnergyValue = document.getElementById('statEnergyValue');
    const statEnergyTimer = document.getElementById('statEnergyTimer');
    const statTraceValue = document.getElementById('statTraceValue');
    const statTraceTimer = document.getElementById('statTraceTimer');
    const statEnergyPack = document.getElementById('statEnergyPack');
    const statLastSave = document.getElementById('statLastSave');
    const btnUseEnergyPack = document.getElementById('btnUseEnergyPack');
    const energyBarInner = document.getElementById('energyBarInner');
    const traceBarInner = document.getElementById('traceBarInner');

    const logList = document.getElementById('logList');

    const btnScan = document.getElementById('btnScan');
    const btnHack = document.getElementById('btnHack');
    const btnUpgradeCpu = document.getElementById('btnUpgradeCpu');
    const btnUpgradeCode = document.getElementById('btnUpgradeCode');
    const btnEvolveCode = document.getElementById('btnEvolveCode');

    const shopList = document.getElementById('shopList');
    const shopSortSelect = document.getElementById('shopSortSelect');
    const serverSelect = document.getElementById('serverSelect');
    const serverMeta = document.getElementById('serverMeta');

    const codeListEl = document.getElementById('codeList');
    const codeDetailEl = document.getElementById('codeDetail');

    const scanOverlay = document.getElementById('scanOverlay');
    const scanProgressInner = document.getElementById('scanProgressInner');
    const scanText = document.getElementById('scanText');

    const leftPanel = document.getElementById('leftPanel');
    const centerPanel = document.getElementById('centerPanel');
    const rightPanel = document.getElementById('rightPanel');
    const main = document.getElementById('main');
    const toastContainer = document.getElementById('toastContainer');

    const resizerLeft = document.getElementById('resizerLeft');
    const resizerRight = document.getElementById('resizerRight');

    const btnMore = document.getElementById('btnMore');
    const moreModalBackdrop = document.getElementById('moreModalBackdrop');
    const btnMoreClose = document.getElementById('btnMoreClose');
    const btnMoreClose2 = document.getElementById('btnMoreClose2');

    const btnSaveGame = document.getElementById('btnSaveGame');
    const btnLoadGame = document.getElementById('btnLoadGame');
    const btnClearSave = document.getElementById('btnClearSave');

    const missionListEl = document.getElementById('missionList');
    const achievementListEl = document.getElementById('achievementList');

    const chkRiskMode = document.getElementById('chkRiskMode');
    const loadoutSelect = document.getElementById('loadoutSelect');
    const btnSaveLoadout = document.getElementById('btnSaveLoadout');
    const btnLoadLoadout = document.getElementById('btnLoadLoadout');

    // ì•¡ì…˜ ì ê¸ˆ ìƒíƒœ (ìŠ¤ìº” ì• ë‹ˆë©”ì´ì…˜/Trace ì°¨ë‹¨ ë“±)
    let actionBusy = false;

    const filterSystem = document.getElementById('filterSystem');
    const filterScan = document.getElementById('filterScan');
    const filterHack = document.getElementById('filterHack');
    const filterShop = document.getElementById('filterShop');
    const filterLevel = document.getElementById('filterLevel');

    const moreTabButtons = document.querySelectorAll('.more-tab-button');
    const tabUpdate = document.getElementById('tabUpdate');
    const tabMission = document.getElementById('tabMission');
    const tabAchievement = document.getElementById('tabAchievement');
    const tabLogs = document.getElementById('tabLogs');
    const tabSettings = document.getElementById('tabSettings');
    const tabSave = document.getElementById('tabSave');
    const tabMail = document.getElementById('tabMail');

    const updateVersionTitle = document.getElementById('updateVersionTitle');
    const updateLinesList = document.getElementById('updateLinesList');
    const updateIndexLabel = document.getElementById('updateIndexLabel');
    const btnUpdatePrev = document.getElementById('btnUpdatePrev');
    const btnUpdateNext = document.getElementById('btnUpdateNext');
    const btnUpdateDontShow = document.getElementById('btnUpdateDontShow');

    const missionScopeButtons = document.querySelectorAll('.mission-scope-btn');
    const btnClearLogs = document.getElementById('btnClearLogs');
    const btnToggleLogs = document.getElementById('btnToggleLogs');
    const logPanelBody = document.getElementById('logPanelBody');
    const logSearchInput = document.getElementById('logSearchInput');

    const setFontScale = document.getElementById('setFontScale');
    const setFontScaleLabel = document.getElementById('setFontScaleLabel');
    const setUiZoom = document.getElementById('setUiZoom');
    const setAnim = document.getElementById('setAnim');
    const setToastMs = document.getElementById('setToastMs');
    const setAutoSaveToast = document.getElementById('setAutoSaveToast');

    const btnExportSave = document.getElementById('btnExportSave');
    const btnImportSaveFile = document.getElementById('btnImportSaveFile');
    const fileImportSave = document.getElementById('fileImportSave');
    const importSaveText = document.getElementById('importSaveText');
    const btnImportSaveText = document.getElementById('btnImportSaveText');

    // ìƒíƒœ
    let missionScopeActive = 'daily';
    let logsHidden = false;
    let scanRunning = false;

    function getDayKey() {
      return new Date().toISOString().slice(0, 10);
    }
    function getWeekKey() {
      return Math.floor(Date.now() / (7 * 24 * 3600 * 1000));
    }
    function getMonthKey() {
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
    }

    function updateStatsUI() {
      statLevel.textContent = state.level;
      statExp.textContent = state.exp + ' / ' + state.requiredExp;
      statCredits.textContent = state.credits;
      statCpuTier.textContent = state.cpuTier;
      statEnergyValue.textContent = `${state.energy} / ${state.energyMax}`;

      if (state.energy >= state.energyMax) {
        statEnergyTimer.textContent = 'FULL';
      } else {
        const sec = state.energyTimerMs / 1000;
        statEnergyTimer.textContent = sec.toFixed(1) + 'ì´ˆ';
      }

      const ratio = state.energy / state.energyMax;
      energyBarInner.style.width = (ratio * 100) + '%';

      // Trace Protocol UI
      if (statTraceValue && statTraceTimer && traceBarInner) {
        const tMax = state.traceMax || 100;
        const t = Math.max(0, Math.min(tMax, state.trace || 0));
        statTraceValue.textContent = `${t} / ${tMax}`;

        if ((state.traceLockMs || 0) > 0) {
          statTraceTimer.textContent = `${(state.traceLockMs / 1000).toFixed(1)}ì´ˆ`;
        } else {
          const left = Math.max(0, tMax - t);
          statTraceTimer.textContent = left <= 0 ? 'LOCK' : `${left}`;
        }

        traceBarInner.style.width = ((t / tMax) * 100) + '%';
      }


      chkRiskMode.checked = state.riskMode;

      // ì—ë„ˆì§€ íŒ© UI
      const packCount = state.items && typeof state.items.energyPack === 'number' ? state.items.energyPack : 0;
      statEnergyPack.textContent = packCount;
      const canUsePack = packCount > 0 && state.energy < state.energyMax;
      btnUseEnergyPack.disabled = !canUsePack;

      // ë§ˆì§€ë§‰ ì €ì¥ ì‹œê° UI
      if (statLastSave) {
        if (state.lastSavedAt) {
          const d = new Date(state.lastSavedAt);
          const hh = String(d.getHours()).padStart(2,'0');
          const mm = String(d.getMinutes()).padStart(2,'0');
          const ss = String(d.getSeconds()).padStart(2,'0');
          statLastSave.textContent = `${hh}:${mm}:${ss}`;
        } else {
          statLastSave.textContent = '-';
        }
      }

      refreshActionButtonsState();

      renderCodeList();
      renderCodeDetail();
      renderMissions();
      renderAchievements();
    }


    function showToast(message, kind = 'info') {
      if (!toastContainer) return;
      const toast = document.createElement('div');
      toast.className = 'toast';

      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.textContent = String(kind || 'info').toUpperCase();

      const msg = document.createElement('div');
      msg.className = 'msg';
      msg.textContent = message;

      toast.appendChild(tag);
      toast.appendChild(msg);
      toastContainer.appendChild(toast);

      requestAnimationFrame(() => toast.classList.add('show'));

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 220);
      }, (state.ui && state.ui.toastDurationMs) ? state.ui.toastDurationMs : 2200);
    }

    function log(message, type = 'system') {
      // v1.7.x: ë¡œê·¸ ëˆ„ì /ë¬´ì‚¬ ë¡œê·¸(íˆë“  ì—…ì ) ì¶”ì 
      state.stats.logLinesTotal = (state.stats.logLinesTotal || 0) + 1;
      const nowTs = Date.now();
      // ì‹¤íŒ¨/ê²½ê³ ë¡œ ê°„ì£¼í•  ë¡œê·¸
      const failOrWarn = (type === 'hack' && String(message).includes('ì‹¤íŒ¨')) || (type === 'system' && String(message).includes('TRACE ê°ì§€'));
      if (failOrWarn) {
        state.stats.lastLogWasFailOrWarnAt = nowTs;
        state.stats.silentNightBroken = true;
      }
      // SILENT NIGHT: 5ë¶„ ë™ì•ˆ fail/warn ì—†ì´ ìœ ì§€
      if (!state.stats.silentNightStartAt) state.stats.silentNightStartAt = nowTs;
      if (!state.stats.silentNightBroken) {
        if (nowTs - state.stats.silentNightStartAt >= 5 * 60 * 1000) {
          unlockAchievement('hidden_no_fail_5min');
        }
      } else {
        // ê¹¨ì¡Œìœ¼ë©´ ì¬ì¸¡ì • ì‹œì‘
        state.stats.silentNightStartAt = nowTs;
        state.stats.silentNightBroken = false;
      }

      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.dataset.type = type;

      const timeSpan = document.createElement('span');
      timeSpan.className = 'log-time';
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      timeSpan.textContent = `[${hh}:${mm}:${ss}]`;

      const tagSpan = document.createElement('span');
      tagSpan.className = 'log-tag tag-' + type;
      tagSpan.textContent = type.toUpperCase();

      const textSpan = document.createElement('span');
      textSpan.textContent = ' ' + message;

      entry.appendChild(timeSpan);
      entry.appendChild(tagSpan);
      entry.appendChild(textSpan);

      logList.prepend(entry);
      trimLogs();
      applyLogFilter();
    }

    function applyLogFilter() {
      const show = state.logFilter;
      const children = logList.children;
      for (let i = 0; i < children.length; i++) {
        const el = children[i];
        const t = el.dataset.type;
        let visible = true;
        if (t === 'system') visible = show.system;
        else if (t === 'scan') visible = show.scan;
        else if (t === 'hack') visible = show.hack;
        else if (t === 'shop') visible = show.shop;
        else if (t === 'level') visible = show.level;
        // ê²€ìƒ‰ í•„í„°
        const q = (state.ui && state.ui.logSearch) ? String(state.ui.logSearch).trim().toLowerCase() : '';
        if (visible && q) {
          const hay = (el.textContent || '').toLowerCase();
          visible = hay.includes(q);
        }
        el.style.display = visible ? '' : 'none';
      }
    }

    function trimLogs() {
      // í•€(ê³ ì •) ë¡œê·¸ëŠ” ì œì™¸í•˜ê³  ìµœì‹  100ê°œê¹Œì§€ë§Œ ìœ ì§€
      const max = 100;
      const children = Array.from(logList.children);
      const unpinned = children.filter(el => el.dataset && el.dataset.pinned !== '1');
      if (unpinned.length <= max) return;
      let removeCount = unpinned.length - max;
      for (let i = unpinned.length - 1; i >= 0 && removeCount > 0; i--) {
        unpinned[i].remove();
        removeCount--;
      }
    }


    function requiredExp(level) {
      return 20 + (level - 1) * 10;
    }

    function addExp(amount) {
      const finalAmount = Math.max(1, Math.round(amount * modifiers.expMultiplier));
      state.exp += finalAmount;
      let leveledUp = false;
      while (state.exp >= state.requiredExp) {
        state.exp -= state.requiredExp;
        levelUp();
        leveledUp = true;
      }
      if (!leveledUp) updateStatsUI();
    }

    function levelUp() {
      ensureMissionResets();
      state.level++;
      state.requiredExp = requiredExp(state.level);
      state.credits += 100;
      state.stats.creditsEarnedTotal += 100;
      log(`ë ˆë²¨ ì—…! Lv.${state.level} ë‹¬ì„±. í¬ë ˆë”§ +100 ì§€ê¸‰.`, 'level');

      state.missionProgress.weekly.levelReached = Math.max(
        state.missionProgress.weekly.levelReached,
        state.level
      );
      state.missionProgress.month.levelReached = Math.max(
        state.missionProgress.month.levelReached,
        state.level
      );
      checkMissions('weekly');
      checkMissions('month');
      checkMissions('general');
      checkMissions('stage');
      checkAchievements('levelUp');
      updateStatsUI();
    }

    function consumeEnergy(amount) {
      ensureMissionResets();
      if (state.energy < amount) {
        if (state.energy === 0) {
          state.stats.energy0Attempted = true;
          unlockAchievement('hidden_energy0_attempt');
        }
        return false;
      }
      state.energy -= amount;
      state.stats.energySpentTotal += amount;

      state.missionProgress.daily.energySpent += amount;
      state.missionProgress.weekly.energySpent += amount;
      state.missionProgress.month.energySpent += amount;

      checkMissions('daily');
      checkMissions('weekly');
      checkMissions('month');
      checkMissions('general');
      checkMissions('stage');

      if (state.energy <= 0) {
        state.energy = 0;
        unlockAchievement('energy_zero');
      }

      if (state.energy < state.energyMax && state.energyTimerMs <= 0) {
        state.energyTimerMs = ENERGY_INTERVAL_MS;
      }
      updateStatsUI();
      return true;
    }

    function useEnergyPack() {
      ensureMissionResets();
      state.items = state.items || { energyPack: 0 };

      const packCount = state.items.energyPack || 0;
      if (packCount <= 0) {
        log('ì—ë„ˆì§€ íŒ©ì´ ì—†ìŠµë‹ˆë‹¤.', 'system');
        return;
      }
      if (state.energy >= state.energyMax) {
        log('ì´ë¯¸ ì—ë„ˆì§€ê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.', 'system');
        return;
      }

      state.items.energyPack = packCount - 1;
      state.energy = state.energyMax;
      state.energyTimerMs = 0;

      state.stats.energyPacksUsed = (state.stats.energyPacksUsed || 0) + 1;

      log('ì—ë„ˆì§€ íŒ© 1ê°œë¥¼ ì‚¬ìš©í•´ ì—ë„ˆì§€ë¥¼ ìµœëŒ€ì¹˜ê¹Œì§€ íšŒë³µí–ˆìŠµë‹ˆë‹¤.', 'system');
      updateStatsUI();
      saveGame();
    }

    setInterval(() => {
      // Trace Protocol: ì°¨ë‹¨ ì¹´ìš´íŠ¸ë‹¤ìš´ + ìì—° ê°ì†Œ
      let traceUIShouldUpdate = false;
      if (typeof state.trace !== 'number') state.trace = 0;
      state.traceMax = state.traceMax || 100;
      state.traceLockMs = state.traceLockMs || 0;
      state.traceDecayAccMs = state.traceDecayAccMs || 0;

      if (state.traceLockMs > 0) {
        state.trace = state.traceMax;
        state.traceLockMs = Math.max(0, state.traceLockMs - 100);
        traceUIShouldUpdate = true;
        if (state.traceLockMs === 0) {
          // ì°¨ë‹¨ í•´ì œ ì‹œ Traceë¥¼ ì¼ë¶€ ë‚¨ê¸°ê³  ë³µê·€
          state.trace = Math.min(state.traceMax, Math.round(state.traceMax * 0.6));
          showToast('TRACE ì°¨ë‹¨ í•´ì œ', 'ok');
          log('TRACE ì°¨ë‹¨ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'system');
          state.stats.justUnlockedFromLock = true;
          refreshActionButtonsState();
        }
      } else if (state.trace > 0) {
        state.traceDecayAccMs += 100;
        if (state.traceDecayAccMs >= 1000) {
          const steps = Math.floor(state.traceDecayAccMs / 1000);
          state.traceDecayAccMs -= steps * 1000;
          const decay = steps; // ì´ˆë‹¹ 1 ê°ì†Œ
          const before = state.trace;
          state.trace = Math.max(0, state.trace - decay);
          if (before !== state.trace) {
            traceUIShouldUpdate = true;
            const diff = before - state.trace;
            if (diff > 0) {
              state.stats.traceReducedCount = (state.stats.traceReducedCount || 0) + diff;
              if (state.trace === 0) {
                state.stats.traceZeroCount = (state.stats.traceZeroCount || 0) + 1;
              }
            }
          }
        }
      }

      if (state.energy >= state.energyMax) {
        state.energy = state.energyMax;
        state.energyTimerMs = 0;
        updateStatsUI();
        return;
      }
      if (state.energyTimerMs > 0) {
        state.energyTimerMs = Math.max(0, state.energyTimerMs - 100);
        if (state.energyTimerMs <= 0) {
          state.energy++;
          if (state.energy < state.energyMax) {
            state.energyTimerMs = ENERGY_INTERVAL_MS;
          } else {
            state.energyTimerMs = 0;
          }
        }
        updateStatsUI();
      }
      // ì—ë„ˆì§€ ê°±ì‹ ì´ ì—†ë”ë¼ë„ Trace UIëŠ” ê°±ì‹ ë˜ì–´ì•¼ í•¨
      if (traceUIShouldUpdate && state.energyTimerMs <= 0) {
        updateStatsUI();
      }
    }, 100);

    function getOwnedCode(id) {
      return ownedCodes.find(c => c.id === id) || null;
    }

    function addCodeInstanceFromTemplate(templateId) {
      const def = codeDefs[templateId];
      if (!def) return;
      const exists = getOwnedCode(templateId);
      if (exists) return;
      ownedCodes.push({
        id: def.id,
        name: def.name,
        rarity: def.rarity,
        power: def.basePower,
        level: 1,
        usage: 0
      });
    }

    function renderCodeList() {
      codeListEl.innerHTML = '';
      if (ownedCodes.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'ë³´ìœ  ì½”ë“œ ì—†ìŒ. [ì½”ë“œ ìŠ¤ìº”]ìœ¼ë¡œ ì½”ë“œë¥¼ ì–»ìœ¼ì„¸ìš”.';
        li.style.opacity = '0.7';
        codeListEl.appendChild(li);
        return;
      }

      ownedCodes.forEach(code => {
        const li = document.createElement('li');
        if (state.activeCodeId === code.id) li.classList.add('active');

        const left = document.createElement('span');
        left.textContent = code.name;
        const rarityClass = 'rarity-' + code.rarity.toLowerCase();
        left.classList.add(rarityClass);

        const right = document.createElement('span');
        right.className = 'meta';
        right.textContent = `[${code.rarity}] Lv.${code.level} / PWR ${code.power}`;

        li.appendChild(left);
        li.appendChild(right);

        li.addEventListener('click', () => {
          state.activeCodeId = code.id;
          updateStatsUI();
          log(`í™œì„± ì½”ë“œ ë³€ê²½: ${code.name}`, 'system');
        });

        codeListEl.appendChild(li);
      });
    }

    function renderCodeDetail() {
      const code = getActiveCodeInstance();
      if (!code) {
        codeDetailEl.innerHTML = '<div class="small">ë³´ìœ  ì¤‘ì¸ ì½”ë“œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
        return;
      }
      const def = codeDefs[code.id];
      const ability = def ? def.description : 'ì„¤ëª… ì—†ìŒ.';
      const usage = code.usage || 0;
      const rarityClass = 'rarity-' + code.rarity.toLowerCase();

      const html = `
        <div style="margin-bottom:4px;">
          <strong class="${rarityClass}">${code.name}</strong>
          <span class="rarity-tag ${rarityClass}">[${code.rarity}]</span>
        </div>
        <div class="small">ë ˆë²¨: Lv.${code.level}</div>
        <div class="small">íŒŒì›Œ: ${code.power}</div>
        <div class="small">ì‚¬ìš© íšŸìˆ˜: ${usage}</div>
        <div class="small" style="margin-top:6px; color:#a5b4fc;">ëŠ¥ë ¥</div>
        <div class="small">${ability}</div>
      `;
      codeDetailEl.innerHTML = html;
    }

    function getActiveCodeInstance() {
      if (!state.activeCodeId && ownedCodes.length > 0) {
        state.activeCodeId = ownedCodes[0].id;
      }
      return state.activeCodeId ? getOwnedCode(state.activeCodeId) : null;
    }

    function upgradeSelectedCode() {
      const code = getActiveCodeInstance();
      if (!code) {
        log('ê°•í™”í•  ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”.', 'system');
        return;
      }
      const cost = 100 * code.level;
      if (state.credits < cost) {
        log(`ì½”ë“œ ê°•í™” ì‹¤íŒ¨: í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${cost})`, 'system');
        return;
      }
      state.credits -= cost;
      code.level++;
      code.power += 5;
      log(`ì½”ë“œ ê°•í™”: ${code.name} Lv.${code.level} (íŒŒì›Œ +5 â†’ ${code.power}), í¬ë ˆë”§ -${cost}.`, 'system');
      updateStatsUI();
      checkMissions('general');
      checkMissions('stage');
    }

    function evolveSelectedCode() {
      const code = getActiveCodeInstance();
      if (!code) {
        log('ì§„í™”í•  ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.', 'system');
        return;
      }
      if (code.rarity === 'LEGENDARY') {
        log('ì´ë¯¸ ìµœìƒìœ„ í¬ê·€ë„(LEGENDARY)ì…ë‹ˆë‹¤. ë” ì´ìƒ ì§„í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'system');
        return;
      }
      if (code.level < 5) {
        log('ì½”ë“œ ì§„í™” ì‹¤íŒ¨: ì§„í™”ì—ëŠ” ìµœì†Œ Lv.5 ì´ìƒì´ í•„ìš”í•©ë‹ˆë‹¤.', 'system');
        return;
      }
      const idx = rarityOrder.indexOf(code.rarity);
      if (idx === -1 || idx === rarityOrder.length - 1) {
        log('ì§„í™”ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'system');
        return;
      }
      const nextRarity = rarityOrder[idx + 1];
      code.rarity = nextRarity;
      code.power += 10;
      log(`ì½”ë“œ ì§„í™” ì„±ê³µ: ${code.name}ê°€ ${nextRarity} ë“±ê¸‰ìœ¼ë¡œ ìŠ¹ê¸‰, íŒŒì›Œ +10 â†’ ${code.power}.`, 'system');

      if (nextRarity === 'EPIC' || nextRarity === 'LEGENDARY') {
        unlockAchievement('get_epic_code');
      }
      updateStatsUI();
      checkMissions('general');
      checkMissions('stage');
    }

    function renderServers() {
      serverSelect.innerHTML = '';
      servers.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        const fw = (typeof s.firewall === 'number') ? s.firewall : s.security;
        const ts = (typeof s.traceSensitivity === 'number') ? s.traceSensitivity : 1.0;
        const rm = (typeof s.rewardMultiplier === 'number') ? s.rewardMultiplier : 1.0;
        option.textContent = `${s.name} (ë³´ì•ˆ ${s.security}, FW ${fw}, Trace x${ts.toFixed(2)}, ë³´ìƒ x${rm.toFixed(2)}, Lv${s.minLevel}+ )`;
        serverSelect.appendChild(option);
      });
      updateServerMeta();
    }

    function updateServerMeta() {
      if (!serverMeta) return;
      const s = getSelectedServer();
      if (!s) {
        serverMeta.textContent = '-';
        return;
      }
      const fw = (typeof s.firewall === 'number') ? s.firewall : s.security;
      const ts = (typeof s.traceSensitivity === 'number') ? s.traceSensitivity : 1.0;
      const rm = (typeof s.rewardMultiplier === 'number') ? s.rewardMultiplier : 1.0;
      serverMeta.textContent = `ë³´ì•ˆ ${s.security} / ë°©í™”ë²½ ${fw} / ì¶”ì ê°ë„ x${ts.toFixed(2)} / ë³´ìƒê³„ìˆ˜ x${rm.toFixed(2)}`;
    }

    // =========================
    // SHOP LIMITS (Daily / One-time)
    // =========================
    // SHOP LIMITS (Daily / One-time)
    // =========================
    const SHOP_LIMITS = {
      // Daily cap
      big_credit_pack: { type: 'daily', limit: 2, label: '05:00 ë¦¬ì…‹ (2íšŒ)' },
      // One-time (no stacking)
      perm_credit_boost: { type: 'once', limit: 1, label: '1íšŒ' },
      risk_support: { type: 'once', limit: 1, label: '1íšŒ' },
      scanner_plus: { type: 'once', limit: 1, label: '1íšŒ' }
    };

    const SHOP_META_KEY = 'HCSIG_SHOP_META_V1';

    function getLocalDateKey() {
      // SERVER RESET KEY (fixed 05:00 KST)
      // 05:00 ì´ì „ì—ëŠ” 'ì „ë‚ 'ë¡œ ê°„ì£¼, 05:00 ì´í›„ëŠ” 'ë‹¹ì¼'ë¡œ ê°„ì£¼
      const RESET_HOUR = 5;
      const d = new Date();
      if (d.getHours() < RESET_HOUR) d.setDate(d.getDate() - 1);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function loadShopMeta() {
      try {
        const raw = localStorage.getItem(SHOP_META_KEY);
        if (!raw) throw new Error('empty');
        const meta = JSON.parse(raw);
        if (!meta || typeof meta !== 'object') throw new Error('bad');
        if (!meta.daily) meta.daily = {};
        if (!meta.once) meta.once = {};
        return meta;
      } catch (e) {
        return { date: getLocalDateKey(), daily: {}, once: {} };
      }
    }

    function saveShopMeta(meta) {
      localStorage.setItem(SHOP_META_KEY, JSON.stringify(meta));
    }

    function ensureDailyShopReset() {
      const meta = loadShopMeta();
      const today = getLocalDateKey();
      if (meta.date !== today) {
        meta.date = today;
        meta.daily = {}; // reset daily counts
        saveShopMeta(meta);
        log('[ì‹œìŠ¤í…œ] ì¼ì¼ ìƒì  ì œí•œì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (05:00 ë¦¬ì…‹)', 'system');
      }
      return meta;
    }

    function getShopLimitInfo(itemId) {
      return SHOP_LIMITS[itemId] || null;
    }

    function getShopRemaining(itemId) {
      const info = getShopLimitInfo(itemId);
      if (!info) return null;
      const meta = ensureDailyShopReset();
      if (info.type === 'daily') {
        const used = meta.daily[itemId] || 0;
        return { used, limit: info.limit, remaining: Math.max(0, info.limit - used), type: info.type, label: info.label };
      }
      if (info.type === 'once') {
        const bought = !!meta.once[itemId];
        return { used: bought ? 1 : 0, limit: 1, remaining: bought ? 0 : 1, type: info.type, label: info.label };
      }
      return null;
    }

    function canBuyShopItem(itemId) {
      const info = getShopRemaining(itemId);
      if (!info) return { ok: true };
      if (info.remaining <= 0) {
        return { ok: false, reason: info.type === 'daily' ? 'ì˜¤ëŠ˜ êµ¬ë§¤ ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.' : 'ì´ë¯¸ êµ¬ë§¤í•œ ì˜êµ¬ ì•„ì´í…œì…ë‹ˆë‹¤.' };
      }
      return { ok: true };
    }

    function markShopPurchase(itemId) {
      const info = getShopLimitInfo(itemId);
      if (!info) return;
      const meta = ensureDailyShopReset();
      if (info.type === 'daily') {
        meta.daily[itemId] = (meta.daily[itemId] || 0) + 1;
      } else if (info.type === 'once') {
        meta.once[itemId] = true;
      }
      saveShopMeta(meta);
    }

    // Reset daily limits automatically at server reset time (fixed 05:00 KST)
    setInterval(() => { try { ensureDailyShopReset(); } catch(e){} }, 60 * 1000);



    function renderShop() {
      shopList.innerHTML = '';

      const categoryLabel = {
        ENERGY: 'ì—ë„ˆì§€',
        UTILITY: 'ìœ í‹¸',
        ECONOMY: 'ê²½ì œ',
        SYSTEM: 'ì‹œìŠ¤í…œ'
      };

      const rarityRank = {
        COMMON: 1,
        UNCOMMON: 2,
        RARE: 3,
        EPIC: 4,
        LEGENDARY: 5
      };

      const baseOrder = new Map();
      shopItems.forEach((it, idx) => baseOrder.set(it.id, idx));

      const mode = (state.ui && state.ui.shopSortMode) ? state.ui.shopSortMode : 'update';
      const items = shopItems.slice();

      if (mode === 'rarity') {
        items.sort((a, b) => {
          const ra = rarityRank[a.rarity] || 0;
          const rb = rarityRank[b.rarity] || 0;
          if (rb !== ra) return rb - ra;
          return (baseOrder.get(a.id) || 0) - (baseOrder.get(b.id) || 0);
        });
      }
      else if (mode === 'new') {
        items.sort((a, b) => (baseOrder.get(b.id) || 0) - (baseOrder.get(a.id) || 0));
      }
      else if (mode === 'price') {
        items.sort((a, b) => {
          const pa = Number(a.cost || 0);
          const pb = Number(b.cost || 0);
          if (pa !== pb) return pa - pb;
          return (baseOrder.get(a.id) || 0) - (baseOrder.get(b.id) || 0);
        });
      }
      else if (mode === 'name') {
        items.sort((a, b) => {
          const na = String(a.name || '');
          const nb = String(b.name || '');
          const c = na.localeCompare(nb, 'ko');
          if (c !== 0) return c;
          return (baseOrder.get(a.id) || 0) - (baseOrder.get(b.id) || 0);
        });
      }

      items.forEach(item => {
        const wrapper = document.createElement('div');
        wrapper.className = 'shop-item';

        const head = document.createElement('div');
        head.className = 'shop-head';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'shop-name';

        const rarityClass = 'shop-rarity-' + item.rarity.toLowerCase();
        const raritySpan = document.createElement('span');
        raritySpan.className = 'shop-rarity-pill ' + rarityClass;
        raritySpan.textContent = item.rarity;

        const catSpan = document.createElement('span');
        catSpan.className = 'shop-cat-pill';
        catSpan.textContent = categoryLabel[item.category] || item.category || '';

        const leftWrap = document.createElement('span');
        leftWrap.appendChild(raritySpan);
        leftWrap.appendChild(catSpan);
        leftWrap.appendChild(document.createTextNode(item.name));

        const costSpan = document.createElement('span');
        costSpan.className = 'shop-cost';
        costSpan.textContent = `ğŸ’° ${item.cost}`;

        
        // limit badge (daily/once)
        const lim = getShopRemaining(item.id);
        if (lim) {
          const badge = document.createElement('span');
          badge.className = 'shop-limit-badge';
          badge.textContent = `${lim.used}/${lim.limit} (${lim.label})`;
          badge.style.marginLeft = '8px';
          badge.style.opacity = '0.85';
          costSpan.appendChild(badge);
        }
nameSpan.appendChild(leftWrap);

        head.appendChild(nameSpan);
        head.appendChild(costSpan);

        const desc = document.createElement('div');
        desc.className = 'shop-desc';
        desc.textContent = item.desc;

        const btn = document.createElement('button');
        btn.className = 'shop-buy';
        btn.textContent = 'êµ¬ë§¤';
        btn.title = 'êµ¬ë§¤í•˜ë©´ í¬ë ˆë”§ì´ ì†Œëª¨ë©ë‹ˆë‹¤.';
        
        const lim2 = getShopRemaining(item.id);
        if (lim2 && lim2.remaining <= 0) {
          btn.disabled = true;
          btn.textContent = 'êµ¬ë§¤ ë¶ˆê°€';
          btn.title = lim2.type === 'daily' ? 'ì˜¤ëŠ˜ êµ¬ë§¤ ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.' : 'ì´ë¯¸ êµ¬ë§¤í•œ ì˜êµ¬ ì•„ì´í…œì…ë‹ˆë‹¤.';
        }
btn.addEventListener('click', () => {
          
          // purchase cap check (daily/once)
          const cap = canBuyShopItem(item.id);
          if (!cap.ok) {
            log(`[ìƒì ] ${cap.reason}`, 'shop');
            showToast(cap.reason, 'shop');
            return;
          }
if (state.credits < item.cost) {
            log(`[ìƒì ] í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${item.cost})`, 'shop');
            showToast('í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'shop');
            return;
          }
          // ê³ ê°€/ê³ í¬ê·€ êµ¬ë§¤ í™•ì¸
          const rr = rarityRank[item.rarity] || 0;
          if (rr >= 4) {
            const ok = window.confirm(`${item.name} (${item.rarity}) ì„(ë¥¼) êµ¬ë§¤í• ê¹Œìš”?\nğŸ’° ${item.cost} í¬ë ˆë”§ì´ ì†Œëª¨ë©ë‹ˆë‹¤.`);
            if (!ok) return;
          }
          state.credits -= item.cost;
          item.buy?.();
          state.stats.shopPurchaseCount++;
          
          markShopPurchase(item.id);
log(`[ìƒì ] ${item.name} êµ¬ë§¤ (ğŸ’° -${item.cost})`, 'shop');
          if (item.id === 'energy_pack') {
            showToast(`ì—ë„ˆì§€ íŒ© +1 (ë³´ìœ : ${state.items.energyPack})`, 'shop');
          } else {
            showToast(`${item.name} êµ¬ë§¤ ì™„ë£Œ`, 'shop');
          }
          unlockAchievement('shop_first_buy');
          updateStatsUI();
          renderShop();
        });

        const foot = document.createElement('div');
        foot.className = 'shop-foot';
        foot.appendChild(btn);

        wrapper.appendChild(head);
        wrapper.appendChild(desc);
        wrapper.appendChild(foot);

        shopList.appendChild(wrapper);
      });
    }
    function rollRarity() {
      const total =
        rarityWeights.COMMON +
        rarityWeights.UNCOMMON +
        rarityWeights.RARE +
        rarityWeights.EPIC +
        rarityWeights.LEGENDARY;
      let r = Math.random() * total;
      for (const rar of rarityOrder) {
        const w = rarityWeights[rar];
        if (r < w) return rar;
        r -= w;
      }
      return 'COMMON';
    }

    function getScanDurationForRarity(rarity) {
      switch (rarity) {
        case 'COMMON': return 500;
        case 'UNCOMMON': return 650;
        case 'RARE': return 800;
        case 'EPIC': return 1000;
        case 'LEGENDARY': return 1200;
        default: return 600;
      }
    }

    function randomScanLine(length) {
      const chars = '01{}[]<>#/\\\\=+-_ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let s = '';
      for (let i = 0; i < length; i++) {
        s += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return s;
    }

    function runScanAnimation(totalDuration, onDone) {
      if (scanRunning) return;
      scanRunning = true;
      scanOverlay.classList.add('active');
      scanText.textContent = '';

      let progress = 0;
      const step = 60;
      const steps = Math.max(3, Math.round(totalDuration / step));
      let currentStep = 0;

      const interval = setInterval(() => {
        currentStep++;
        progress = (currentStep / steps) * 100;
        scanProgressInner.style.width = progress + '%';

        const lineCount = 12;
        let text = '';
        for (let i = 0; i < lineCount; i++) {
          text += randomScanLine(40) + '\n';
        }
        scanText.textContent = text;

        if (currentStep >= steps) {
          clearInterval(interval);
          setTimeout(() => {
            scanOverlay.classList.remove('active');
            scanProgressInner.style.width = '0%';
            scanText.textContent = '';
            scanRunning = false;
            onDone && onDone();
          }, 150);
        }
      }, step);
    }

    
    function isTraceLocked() {
      return (state.traceLockMs || 0) > 0;
    }

    function refreshActionButtonsState() {
      // ê¸°ë³¸ íˆ´íŒ ë³´ê´€
      if (!btnScan.dataset.defaultTitle) btnScan.dataset.defaultTitle = btnScan.title || '';
      if (!btnHack.dataset.defaultTitle) btnHack.dataset.defaultTitle = btnHack.title || '';
      if (!btnUpgradeCpu.dataset.defaultTitle) btnUpgradeCpu.dataset.defaultTitle = btnUpgradeCpu.title || '';

      const locked = isTraceLocked();
      const disabled = !!actionBusy || locked;
      btnScan.disabled = disabled;
      btnHack.disabled = disabled;
      btnUpgradeCpu.disabled = disabled;

      if (locked) {
        const msg = 'TRACE ì°¨ë‹¨ ì¤‘ì…ë‹ˆë‹¤.';
        btnScan.title = msg;
        btnHack.title = msg;
        btnUpgradeCpu.title = msg;
      } else {
        // ë³µì›
        btnScan.title = btnScan.dataset.defaultTitle;
        btnHack.title = btnHack.dataset.defaultTitle;
        btnUpgradeCpu.title = btnUpgradeCpu.dataset.defaultTitle;
      }
    }


function triggerTraceLock(reason = '') {
      state.stats.lockdownCount = (state.stats.lockdownCount || 0) + 1;
      state.stats.justUnlockedFromLock = false;
      // ë½ë‹¤ìš´ ì´í›„ ì²« ì„±ê³µ(í€˜ìŠ¤íŠ¸/íˆë“ ) ì¶”ì 
      state.stats.postLockPending = true;
      state.trace = state.traceMax;
      state.traceLockMs = 30000; // 30ì´ˆ ì°¨ë‹¨
      state.traceDecayAccMs = 0;
      showToast(`TRACE ê°ì§€! ${(state.traceLockMs / 1000).toFixed(0)}ì´ˆ ì°¨ë‹¨`, 'warn');
      log(`TRACE ê°ì§€! ${(state.traceLockMs / 1000).toFixed(0)}ì´ˆ ë™ì•ˆ ì—°ê²°ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.${reason ? ' (' + reason + ')' : ''}`, 'system');
      refreshActionButtonsState();
    }

    function addTrace(amount, reason = '') {
      if (!amount || amount <= 0) return;
      if (isTraceLocked()) return;
      if (typeof state.trace !== 'number') state.trace = 0;
      if (!state.traceMax) state.traceMax = 100;

      state.trace = Math.max(0, Math.min(state.traceMax, state.trace + amount));
      state.traceDecayAccMs = 0;

      // v1.7.x: Trace ì„ê³„(íˆë“ )
      if (state.trace >= 95) unlockAchievement('hidden_trace95');

      // ì„ê³„ì¹˜ ë„ë‹¬ â†’ ì°¨ë‹¨
      if (state.trace >= state.traceMax) {
        triggerTraceLock(reason);
      }
      updateStatsUI();
    }


    function scanForCode() {
      ensureMissionResets();

      if (isTraceLocked()) {
        showToast('TRACE ì°¨ë‹¨ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.', 'warn');
        log('TRACE ì°¨ë‹¨ ì¤‘: ì½”ë“œ ìŠ¤ìº”ì´ ì œí•œë©ë‹ˆë‹¤.', 'system');
        state.stats.lockAttempted = true;
        unlockAchievement('hidden_lock_attempt');
        return;
      }

      const energyCost = 1;
      if (!consumeEnergy(energyCost)) {
        log('ì—ë„ˆì§€ê°€ ë¶€ì¡±í•˜ì—¬ ì½”ë“œ ìŠ¤ìº”ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'scan');
        return;
      }
      state.stats.scanCount++;
      state.missionProgress.daily.scans++;
      state.missionProgress.daily.actions++;

      // v1.7.x: í–‰ë™ ì—°ì†(íˆë“ ) ì¶”ì 
      if (state.stats.sameActionLast === 'scan') state.stats.sameActionStreak = (state.stats.sameActionStreak || 0) + 1;
      else { state.stats.sameActionLast = 'scan'; state.stats.sameActionStreak = 1; }
      if (state.stats.sameActionStreak >= 20) unlockAchievement('hidden_same_action_20');
      state.missionProgress.weekly.scans++;
      state.missionProgress.month.scans++;
      checkMissions('daily');
      checkMissions('weekly');
      checkMissions('month');
      checkMissions('general');
      checkMissions('stage');

      if (scanRunning) return;

      const rarity = rollRarity();
      const duration = getScanDurationForRarity(rarity);

      actionBusy = true;
      refreshActionButtonsState();

      runScanAnimation(duration, () => {
        const templates = Object.values(codeDefs).filter(d => d.rarity === rarity);
        let chosen = null;

        if (templates.length > 0) {
          const candidatesNew = templates.filter(t => !getOwnedCode(t.id));
          if (candidatesNew.length > 0) {
            chosen = candidatesNew[Math.floor(Math.random() * candidatesNew.length)];
          } else {
            chosen = templates[Math.floor(Math.random() * templates.length)];
          }
        }
        if (!chosen) chosen = codeDefs.basic;

        const existing = getOwnedCode(chosen.id);
        if (!existing) {
          addCodeInstanceFromTemplate(chosen.id);
          log(`ìƒˆ ì½”ë“œ ë°œê²¬! ${chosen.name} [${chosen.rarity}]`, 'scan');
          const def = codeDefs[chosen.id];
          if (def && (def.rarity === 'EPIC' || def.rarity === 'LEGENDARY')) {
            unlockAchievement('get_epic_code');
          }
        } else {
          const addPower = rarityPowerUp[rarity] || 1;
          existing.power += addPower;
          log(`ì¤‘ë³µ ì½”ë“œ ê°ì§€: ${chosen.name} [${rarity}] â†’ íŒŒì›Œ +${addPower} (í˜„ì¬ ${existing.power})`, 'scan');
          const def = codeDefs[existing.id];
          if (def && (def.rarity === 'EPIC' || def.rarity === 'LEGENDARY')) {
            unlockAchievement('get_epic_code');
          }
        }

        const expGain = 2 + modifiers.scanExtraExp;
        addExp(expGain);
        log(`ì½”ë“œ ìŠ¤ìº” ì™„ë£Œ: ê²½í—˜ì¹˜ +${expGain}.`, 'scan');
        // Trace Protocol: ìŠ¤ìº” ì‹œ ì¶”ì  ìˆ˜ì¹˜ ìƒìŠ¹(í¬ê·€ë„ë³„)
        const traceGainMap = { COMMON: 2, UNCOMMON: 3, RARE: 4, EPIC: 6, LEGENDARY: 8 };
        addTrace(traceGainMap[rarity] || 2, 'scan');


        checkAchievements('scan');
        checkMissions('general');
      checkMissions('stage');

        actionBusy = false;
        refreshActionButtonsState();
      });
    }

    function getSelectedServer() {
      const id = serverSelect.value;
      return servers.find(s => s.id === id) || servers[0];
    }

    function doHack() {
      ensureMissionResets();

      if (isTraceLocked()) {
        showToast('TRACE ì°¨ë‹¨ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.', 'warn');
        log('TRACE ì°¨ë‹¨ ì¤‘: ì„œë²„ í•´í‚¹ì´ ì œí•œë©ë‹ˆë‹¤.', 'system');
        state.stats.lockAttempted = true;
        unlockAchievement('hidden_lock_attempt');
        return;
      }

      const energyCost = 2;
      if (!consumeEnergy(energyCost)) {
        log('ì—ë„ˆì§€ê°€ ë¶€ì¡±í•˜ì—¬ ì„œë²„ í•´í‚¹ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'hack');
        return;
      }

      state.missionProgress.daily.actions++;

      // v1.7.x: Trace/ì—°ì†/í–‰ë™ ìŠ¤íŠ¸ë¦­ ì¶”ì 
      const traceBefore = state.trace || 0;
      if (state.stats.sameActionLast === 'hack') state.stats.sameActionStreak = (state.stats.sameActionStreak || 0) + 1;
      else { state.stats.sameActionLast = 'hack'; state.stats.sameActionStreak = 1; }
      if (state.stats.sameActionStreak >= 20) unlockAchievement('hidden_same_action_20');

      const code = getActiveCodeInstance();
      if (!code) {
        log('ë³´ìœ  ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì½”ë“œ ìŠ¤ìº”ìœ¼ë¡œ ì½”ë“œë¥¼ í™•ë³´í•˜ì„¸ìš”.', 'hack');
        return;
      }
      const def = codeDefs[code.id];
      const server = getSelectedServer();
      if (!server) {
        log('íƒ€ê²Ÿ ì„œë²„ ì„ íƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'hack');
        return;
      }
      if (state.level < server.minLevel) {
        log(`í•´ë‹¹ ì„œë²„ë¥¼ í•´í‚¹í•˜ë ¤ë©´ ìµœì†Œ Lv.${server.minLevel} ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`, 'hack');
        return;
      }

      let serverSec = (typeof server.firewall === 'number') ? server.firewall : server.security;
      let creditMultiplier = modifiers.creditMultiplierSession * modifiers.creditMultiplierPermanent;
      let successChanceBonus = 0;

      if (def && def.id === 'port_scanner') {
        serverSec = Math.floor(serverSec * 0.9);
      }
      if (def && def.id === 'data_phantom') {
        successChanceBonus += 0.1;
      }
      if (def && def.id === 'overflow_inject') {
        creditMultiplier *= 1.3;
      }

      if (state.riskMode) {
        successChanceBonus -= 0.15;
        successChanceBonus += modifiers.riskSuccessBonus;
        creditMultiplier *= 2.0;
      }

      const effectivePower = code.power * (1 + 0.1 * (state.cpuTier - 1));
      let successChance = effectivePower / (effectivePower + serverSec);
      successChance += successChanceBonus;
      successChance = Math.max(0.05, Math.min(0.95, successChance));

      const success = Math.random() < successChance;

      // Trace Protocol: ì„œë²„ í•´í‚¹ì€ ë³´ì•ˆ/ì¶”ì ê°ë„ì— ë”°ë¼ Traceê°€ ìƒìŠ¹í•©ë‹ˆë‹¤.
      const ts = (typeof server.traceSensitivity === 'number') ? server.traceSensitivity : 1.0;
      let traceGain = (6 + server.security * 0.08) * ts;
      traceGain *= success ? 0.7 : 1.3;
      if (state.riskMode) traceGain *= 1.25;

      // ì½”ë“œ íŠ¹ì„±ì— ë”°ë¥¸ Trace ë³´ì •
      if (def && def.id === 'data_phantom') traceGain *= 0.75;
      if (def && def.id === 'port_scanner') traceGain *= 0.9;
      if (def && def.id === 'overflow_inject') traceGain *= 1.15;

      traceGain = Math.max(2, Math.min(25, Math.round(traceGain)));
      addTrace(traceGain, 'hack');

      code.usage = (code.usage || 0) + 1;

      if (success) {
        // v1.7.x: ì„±ê³µ/ì‹¤íŒ¨ ìŠ¤íŠ¸ë¦­
        state.stats.successStreak = (state.stats.successStreak || 0) + 1;
        state.stats.failStreak = 0;
        state.stats.successStreakMax = Math.max(state.stats.successStreakMax || 0, state.stats.successStreak);
        if (state.stats.comebackArmed) { unlockAchievement('comeback_1'); state.stats.comebackArmed = false; }
        if (state.stats.successStreak >= 3) unlockAchievement('streak_3');
        if (state.stats.successStreak >= 7) unlockAchievement('streak_7');

        // Trace êµ¬ê°„ ì„±ê³µ ì¹´ìš´íŠ¸(ë¯¸ì…˜/ì—…ì )
        if (typeof traceBefore === 'number') {
          if (traceBefore <= 25) state.stats.stealthHackSuccessCount = (state.stats.stealthHackSuccessCount || 0) + 1;
          if (traceBefore >= 75) state.stats.highTraceHackSuccessCount = (state.stats.highTraceHackSuccessCount || 0) + 1;
          if (traceBefore >= 90) unlockAchievement('hidden_last_second');
        }

        // Trace 0% ì„±ê³µ(íˆë“ )
        if ((traceBefore || 0) === 0) {
          state.stats.ghostSuccessAtTrace0 = (state.stats.ghostSuccessAtTrace0 || 0) + 1;
          if (state.stats.ghostSuccessAtTrace0 >= 3) unlockAchievement('hidden_ghost3');
        }

        // LOCK ì´í›„ ì²« ì„±ê³µ ì¶”ì (í€˜ìŠ¤íŠ¸/íˆë“ )
        if (state.stats.postLockPending) {
          state.stats.postLockPending = false;
          state.stats.postLockSuccessCount = (state.stats.postLockSuccessCount || 0) + 1;
          unlockAchievement('hidden_lock_and_clear');
        }

        const rawReward =
          server.minReward + Math.random() * (server.maxReward - server.minReward);
        const serverRewardMul = (typeof server.rewardMultiplier === 'number') ? server.rewardMultiplier : 1.0;
        const rewardCredits = Math.round(rawReward * creditMultiplier * serverRewardMul);
        const gainedExp = 8;

        state.credits += rewardCredits;
        state.stats.creditsEarnedTotal += rewardCredits;
        addExp(gainedExp);

        log(
          `ì„œë²„ í•´í‚¹ ì„±ê³µ! [${server.name}] ì„±ê³µ í™•ë¥  ${Math.round(successChance * 100)}%. ` +
          `í¬ë ˆë”§ +${rewardCredits}, ê²½í—˜ì¹˜ +${gainedExp}.`,
          'hack'
        );

        state.stats.hackSuccessCount++;
        state.missionProgress.daily.hackSuccess++;
        state.missionProgress.weekly.hackSuccess++;
        state.missionProgress.month.hackSuccess++;
        if (state.riskMode) {
          state.stats.riskHackSuccessCount++;
        }

        checkMissions('daily');
        checkMissions('weekly');
        checkMissions('month');
        checkMissions('general');
      checkMissions('stage');

        if (state.stats.hackSuccessCount === 1) {
          unlockAchievement('first_hack_success');
        }
        if (state.stats.hackSuccessCount >= 30) {
          unlockAchievement('hack_30_success');
        }
        if (state.stats.riskHackSuccessCount >= 10) {
          unlockAchievement('risk_10_success');
        }

        if (def && def.id === 'ghost_script') {
          levelUp();
          log('Ghost_Script íš¨ê³¼: ì¶”ê°€ ë ˆë²¨ ì—… ë°œìƒ!', 'hack');
        }
      } else {
        // v1.7.x: ì„±ê³µ/ì‹¤íŒ¨ ìŠ¤íŠ¸ë¦­
        state.stats.failStreak = (state.stats.failStreak || 0) + 1;
        state.stats.successStreak = 0;
        state.stats.failStreakMax = Math.max(state.stats.failStreakMax || 0, state.stats.failStreak);
        if (state.stats.failStreak >= 3) state.stats.comebackArmed = true;

        log(
          `ì„œë²„ í•´í‚¹ ì‹¤íŒ¨. [${server.name}] ì„±ê³µ í™•ë¥  ${Math.round(successChance * 100)}%ì˜€ìŒ.`,
          'hack'
        );

        if (def && def.id === 'overflow_inject') {
          state.energy = Math.max(0, state.energy - 1);
          state.stats.energySpentTotal += 1;
          if (state.energy < state.energyMax && state.energyTimerMs <= 0) {
            state.energyTimerMs = ENERGY_INTERVAL_MS;
          }
          log('Overflow_Inject í˜ë„í‹°: ì—ë„ˆì§€ê°€ ì¶”ê°€ë¡œ 1 ì†Œëª¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'hack');
        }

        if (state.riskMode) {
          state.energy = Math.max(0, state.energy - 1);
          state.stats.energySpentTotal += 1;
          if (state.energy < state.energyMax && state.energyTimerMs <= 0) {
            state.energyTimerMs = ENERGY_INTERVAL_MS;
          }
          log('ìœ„í—˜ í•´í‚¹ ëª¨ë“œ í˜ë„í‹°: ì‹¤íŒ¨ë¡œ ì¸í•´ ì—ë„ˆì§€ê°€ ì¶”ê°€ë¡œ 1 ì†Œëª¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'hack');
          if (state.energy === 0) unlockAchievement('energy_zero');
        }

        if (def && def.id === 'auto_patch' && Math.random() < 0.2) {
          state.exp += 1;
          log('AutoPatch() íš¨ê³¼: í•´í‚¹ ì‹¤íŒ¨ ë³´ì •ìœ¼ë¡œ ê²½í—˜ì¹˜ +1.', 'hack');
        }

        updateStatsUI();
      }

      checkAchievements('hack');
      checkMissions('general');
      checkMissions('stage');
    }

    function upgradeCpu() {
      const rawCost = 500 * state.cpuTier;
      const cost = Math.round(rawCost * modifiers.cpuUpgradeDiscount);
      if (state.credits < cost) {
        log(`CPU ì—…ê·¸ë ˆì´ë“œ ì‹¤íŒ¨: í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${cost})`, 'system');
        return;
      }
      state.credits -= cost;
      state.cpuTier += 1;
      log(`CPU ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ! í˜„ì¬ í‹°ì–´: ${state.cpuTier} (ì†Œëª¨ í¬ë ˆë”§ ${cost})`, 'system');
      if (state.cpuTier >= 5) {
        unlockAchievement('cpu_tier_5');
      }
      updateStatsUI();
      checkMissions('general');
      checkMissions('stage');
    }

    function ensureMissionResets() {
      const dayKey = getDayKey();
      const weekKey = getWeekKey();
      const monthKey = getMonthKey();

      if (state.missionProgress.daily.lastResetDay !== dayKey) {
        state.missionProgress.daily.lastResetDay = dayKey;
        state.missionProgress.daily.scans = 0;
        state.missionProgress.daily.actions = 0;
        state.missionProgress.daily.hackSuccess = 0;
        state.missionProgress.daily.energySpent = 0;
        state.missionProgress.daily.completed = {};
      }

      if (state.missionProgress.weekly.lastResetWeek !== weekKey) {
        state.missionProgress.weekly.lastResetWeek = weekKey;
        state.missionProgress.weekly.scans = 0;
        state.missionProgress.weekly.hackSuccess = 0;
        state.missionProgress.weekly.energySpent = 0;
        state.missionProgress.weekly.levelReached = state.level;
        state.missionProgress.weekly.completed = {};
      }

      if (state.missionProgress.month.lastResetMonth !== monthKey) {
        state.missionProgress.month.lastResetMonth = monthKey;
        state.missionProgress.month.scans = 0;
        state.missionProgress.month.hackSuccess = 0;
        state.missionProgress.month.energySpent = 0;
        state.missionProgress.month.levelReached = state.level;
        state.missionProgress.month.completed = {};
      }

      if (!state.missionProgress.general) {
        state.missionProgress.general = { completed: {} };
      }
      if (!state.missionProgress.general.completed) {
        state.missionProgress.general.completed = {};
      }
    }

    function getMissionProgressValue(scope, type) {
      if (scope === 'daily' || scope === 'weekly' || scope === 'month') {
        if (!state.missionProgress[scope]) state.missionProgress[scope] = { completed: {} };
      const prog = state.missionProgress[scope];
        if (!prog) return 0;
        if (type === 'scans') return prog.scans;
        if (type === 'actions') return prog.actions || 0;
        if (type === 'hackSuccess') return prog.hackSuccess;
        if (type === 'energySpent') return prog.energySpent;
        if (type === 'level') return prog.levelReached;
        if (type === 'riskHackSuccess') return state.stats.riskHackSuccessCount;
        return 0;
      }

      if (scope === 'general' || scope === 'stage') {
        if (type === 'scans') return state.stats.scanCount;
        if (type === 'hackSuccess') return state.stats.hackSuccessCount;
        if (type === 'energySpentTotal') return state.stats.energySpentTotal;
        if (type === 'level') return state.level;
        if (type === 'cpuTier') return state.cpuTier;
        if (type === 'energyMax') return state.energyMax;
        if (type === 'shopPurchases') return state.stats.shopPurchaseCount;
        if (type === 'creditsEarnedTotal') return state.stats.creditsEarnedTotal;
        if (type === 'achievements') return Object.keys(state.achievements).length;
        if (type === 'missionsCompleted') return state.stats.missionsCompletedTotal;
        if (type === 'riskHackSuccess') return state.stats.riskHackSuccessCount;
        // v1.7.x ì½˜í…ì¸ : Trace/ë¡œê·¸/LOCK ì¶•
        if (type === 'traceReduced') return state.stats.traceReducedCount || 0;
        if (type === 'traceZeroCount') return state.stats.traceZeroCount || 0;
        if (type === 'stealthHackSuccess') return state.stats.stealthHackSuccessCount || 0;
        if (type === 'highTraceHackSuccess') return state.stats.highTraceHackSuccessCount || 0;
        if (type === 'postLockSuccess') return state.stats.postLockSuccessCount || 0;
        if (type === 'logsCreated') return state.stats.logLinesTotal || 0;
        if (type === 'energy0Flag') return state.stats.energySpentTotal > 0 && state.energy === 0 ? 1 : 0;
      }
      return 0;
    }

    function checkMissions(scope) {
      const defs = missionDefs[scope];
      if (!defs) return;

      const prog = state.missionProgress[scope];
      if (!prog.completed) prog.completed = {};

      defs.forEach(def => {
        if (prog.completed[def.id]) return;

        // STAGE í€˜ìŠ¤íŠ¸: ì´ì „ ë‹¨ê³„ í´ë¦¬ì–´ ì „ì—ëŠ” ì§„í–‰ ë¶ˆê°€
        if (scope === 'stage') {
          const req = def.requires;
          if (req && !(prog.completed && prog.completed[req])) return;
        }

        if (scope === 'month' && def.type === 'energy0Flag') {
          if (state.energy === 0) {
            prog.completed[def.id] = true;
            state.credits += def.rewardCredits;
            state.stats.creditsEarnedTotal += def.rewardCredits;
            state.stats.missionsCompletedTotal++;
            log(
              `[ë¯¸ì…˜ ì™„ë£Œ] MONTH - ${def.name} (ë³´ìƒ: í¬ë ˆë”§ +${def.rewardCredits})`,
              'system'
            );
          
            showToast(`ë¯¸ì…˜ ì™„ë£Œ: ${def.name} (í¬ë ˆë”§ +${def.rewardCredits})`, 'mission');
}
          return;
        }

        const value = getMissionProgressValue(scope, def.type);
        if (value >= def.target) {
          prog.completed[def.id] = true;

          const rewardCredits = def.rewardCredits || 0;
          if (rewardCredits > 0) {
            state.credits += rewardCredits;
            state.stats.creditsEarnedTotal += rewardCredits;
          }

          // ë³´ì¡° ë³´ìƒ: ì—ë„ˆì§€ íŒ©
          if (def.rewardEnergyPack) {
            state.items = state.items || { energyPack: 0 };
            state.items.energyPack = (state.items.energyPack || 0) + def.rewardEnergyPack;
          }

          state.stats.missionsCompletedTotal++;

          const rewardTextParts = [];
          if (rewardCredits > 0) rewardTextParts.push(`í¬ë ˆë”§ +${rewardCredits}`);
          if (def.rewardEnergyPack) rewardTextParts.push(`ì—ë„ˆì§€ íŒ© +${def.rewardEnergyPack}`);
          const rewardText = rewardTextParts.length ? rewardTextParts.join(', ') : 'ë³´ìƒ ì—†ìŒ';

          log(
            `[ë¯¸ì…˜ ì™„ë£Œ] ${scope.toUpperCase()} - ${def.name} (ë³´ìƒ: ${rewardText})`,
            'system'
          );

          showToast(`ë¯¸ì…˜ ì™„ë£Œ: ${def.name} (${rewardText})`, 'mission');

          if (scope === 'daily') unlockAchievement('daily_mission_clear1');
          if (scope === 'weekly') unlockAchievement('weekly_mission_clear1');

          updateStatsUI();
        }
      });

      if (scope === 'month') {
        const allDone = missionDefs.month.every(def => prog.completed[def.id]);
        if (allDone) {
          unlockAchievement('month_mission_all');
        }
      }

      checkAchievements('missions');
    }

    function renderMissions() {
      missionListEl.innerHTML = '';
      const scope = missionScopeActive;
      const titleMap = {
        daily: 'DAILY QUEST',
        weekly: 'WEEKLY QUEST',
        month: 'MONTH QUEST',
        general: 'GENERAL QUEST',
        stage: 'STAGE QUEST'
      };

      const defs = missionDefs[scope];
      if (!defs) return;

      const header = document.createElement('div');
      header.style.marginBottom = '4px';
      header.style.fontWeight = '600';
      header.textContent = titleMap[scope] || '';
      missionListEl.appendChild(header);

      defs.forEach(def => {
        const progVal = getMissionProgressValue(scope, def.type);
        const progObj = state.missionProgress[scope];
        const completed = !!(progObj && progObj.completed && progObj.completed[def.id]);

        const item = document.createElement('div');
        item.className = 'mission-item';

        const main = document.createElement('div');
        main.className = 'mission-main';
        main.innerHTML = `
          <div>${def.name}</div>
          <div class="mission-progress">${def.desc} (${progVal} / ${def.target})</div>
          <div class="mission-reward">ë³´ìƒ: ${def.rewardCredits ? ('í¬ë ˆë”§ +' + def.rewardCredits) : ''}${def.rewardEnergyPack ? ((def.rewardCredits ? ' / ' : '') + ('ì—ë„ˆì§€ íŒ© +' + def.rewardEnergyPack)) : ''}${(!def.rewardCredits && !def.rewardEnergyPack) ? 'ì—†ìŒ' : ''}</div>
        `;

        const tag = document.createElement('span');
        tag.className = completed ? 'tag-complete' : 'tag-incomplete';
        tag.textContent = completed ? 'ì™„ë£Œ' : 'ë¯¸ì™„';

        item.appendChild(main);
        item.appendChild(tag);
        missionListEl.appendChild(item);
      });
    }

    function unlockAchievement(id) {
      if (state.achievements[id]) return;
      const def = achievementDefs.find(a => a.id === id);
      if (!def) return;
      state.achievements[id] = true;
      log(`[ì—…ì  ë‹¬ì„±] ${def.name}`, 'system');
      showToast(`ì—…ì  ë‹¬ì„±: ${def.name}`, 'achievement');
      renderAchievements();
      checkMissions('general');
      checkMissions('stage'); // ì—…ì  ê¸°ë°˜ GENERAL QUEST ì²´í¬
    }

    function checkAchievements(reason) {
      if (state.level >= 3) unlockAchievement('reach_level3');
      if (state.level >= 10) unlockAchievement('reach_level10');

      if (state.stats.scanCount >= 10) unlockAchievement('scan_10');
      if (state.stats.scanCount >= 30) unlockAchievement('scan_30');
      if (state.stats.scanCount >= 50) unlockAchievement('scan_50');

      if (ownedCodes.length >= 3) unlockAchievement('collector_beginner');

      if (state.stats.hackSuccessCount >= 30) unlockAchievement('hack_30_success');

      if (state.energyMax >= 25) unlockAchievement('energy_max_25');

      if (state.stats.creditsEarnedTotal >= 5000) unlockAchievement('credits_5000');
      if (state.stats.creditsEarnedTotal >= 20000) unlockAchievement('credits_20000');

      if (state.stats.missionsCompletedTotal >= 10) unlockAchievement('mission_10');

      // v1.7.x ì¶”ê°€ ì—…ì  ì¡°ê±´
      if ((state.stats.traceReducedCount || 0) >= 25) unlockAchievement('trace_reduce_25');
      if ((state.stats.traceZeroCount || 0) >= 10) unlockAchievement('trace_zero_10');
      if ((state.stats.stealthHackSuccessCount || 0) >= 20) unlockAchievement('stealth_breacher_20');
      if ((state.stats.highTraceHackSuccessCount || 0) >= 20) unlockAchievement('high_risk_20');
      if ((state.stats.lockdownCount || 0) >= 3) unlockAchievement('lockdown_3');
      if ((state.stats.logLinesTotal || 0) >= 500) unlockAchievement('log_addict_500');
      if ((state.stats.logLinesTotal || 0) >= 1500) unlockAchievement('log_archivist_1500');
      if ((state.stats.shopPurchaseCount || 0) >= 50) unlockAchievement('market_regular_50');
      if ((state.stats.creditsEarnedTotal || 0) >= 50000) unlockAchievement('credits_50000');
    }

    function renderAchievements() {
      achievementListEl.innerHTML = '';

      const diffLabel = {
        easy: 'ì¼ë°˜',
        normal: 'ë³´í†µ',
        hard: 'ì–´ë ¤ì›€'
      };

      achievementDefs.forEach(def => {
        const completed = !!state.achievements[def.id];

        const item = document.createElement('div');
        item.className = 'achievement-item';

        const main = document.createElement('div');
        main.className = 'achievement-main';

        const displayName = def.hidden && !completed ? '???' : def.name;
        const displayDesc = def.hidden && !completed
          ? 'íˆë“  ì—…ì ì…ë‹ˆë‹¤. ë‹¬ì„± ì‹œ ê³µê°œë©ë‹ˆë‹¤.'
          : def.desc;

        let diffClass = 'diff-easy';
        if (def.difficulty === 'normal') diffClass = 'diff-normal';
        else if (def.difficulty === 'hard') diffClass = 'diff-hard';

        main.innerHTML = `
          <div>
            ${displayName}
            <span class="diff-pill ${diffClass}">${diffLabel[def.difficulty] || ''}</span>
            ${def.hidden ? '<span class="diff-pill" style="background:#4b5563;color:#e5e7eb;">HIDDEN</span>' : ''}
          </div>
          <div class="mission-progress">${displayDesc}</div>
        `;

        const tag = document.createElement('span');
        tag.className = completed ? 'tag-complete' : 'tag-incomplete';
        tag.textContent = completed ? 'ë‹¬ì„±' : 'ë¯¸ë‹¬';

        item.appendChild(main);
        item.appendChild(tag);
        achievementListEl.appendChild(item);
      });
    }

    function saveCurrentLoadout() {
      const slot = loadoutSelect.value || '1';
      const code = getActiveCodeInstance();
      const server = getSelectedServer();
      state.loadouts[slot] = {
        codeId: code ? code.id : null,
        serverId: server ? server.id : null,
        riskMode: state.riskMode
      };
      log(`ë¡œë“œì•„ì›ƒ ìŠ¬ë¡¯ ${slot}ì— í˜„ì¬ ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.`, 'system');
    }

    function loadLoadout() {
      const slot = loadoutSelect.value || '1';
      const data = state.loadouts[slot];
      if (!data || (!data.codeId && !data.serverId)) {
        log(`ë¡œë“œì•„ì›ƒ ìŠ¬ë¡¯ ${slot}ì— ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.`, 'system');
        return;
      }
      if (data.codeId && getOwnedCode(data.codeId)) {
        state.activeCodeId = data.codeId;
      }
      if (data.serverId) {
        const s = servers.find(server => server.id === data.serverId);
        if (s) {
          serverSelect.value = data.serverId;
          updateServerMeta();
        }
      }
      state.riskMode = !!data.riskMode;
      chkRiskMode.checked = state.riskMode;
      log(`ë¡œë“œì•„ì›ƒ ìŠ¬ë¡¯ ${slot}ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'system');
      updateStatsUI();
    }

    // ë¦¬ì‚¬ì´ì €
    let isResizing = false;
    let currentResizer = null;

    function onMouseDownResizerLeft(e) {
      isResizing = true;
      currentResizer = 'left';
      e.preventDefault();
    }
    function onMouseDownResizerRight(e) {
      isResizing = true;
      currentResizer = 'right';
      e.preventDefault();
    }
    function onMouseMove(e) {
      if (!isResizing) return;
      const rect = main.getBoundingClientRect();
      const totalWidth = rect.width;

      if (currentResizer === 'left') {
        let newLeftWidth = ((e.clientX - rect.left) / totalWidth) * 100;
        newLeftWidth = Math.max(10, Math.min(40, newLeftWidth));
        leftPanel.style.flex = `0 0 ${newLeftWidth}%`;
      } else if (currentResizer === 'right') {
        if (!rightPanel) return;
        let newRightWidth = ((rect.right - e.clientX) / totalWidth) * 100;
        newRightWidth = Math.max(15, Math.min(45, newRightWidth));
        rightPanel.style.flex = `0 0 ${newRightWidth}%`;
      }
    }
    function onMouseUp() {
      if (!isResizing) return;
      isResizing = false;
      currentResizer = null;
    }

    resizerLeft.addEventListener('mousedown', onMouseDownResizerLeft);
    if (resizerRight && rightPanel) resizerRight.addEventListener('mousedown', onMouseDownResizerRight);
    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);

    // ë”ë³´ê¸° ëª¨ë‹¬ / íƒ­
    function setActiveTab(tabName) {
      const panelMap = {
        update: tabUpdate,
        mission: tabMission,
        achievement: tabAchievement,
        logs: tabLogs,
        settings: tabSettings,
        save: tabSave,
        mail: tabMail
      };
      Object.keys(panelMap).forEach(name => {
        panelMap[name].classList.toggle('active', name === tabName);
      });
      moreTabButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
    

      // tab side-effects
      if (tabName === 'mail') {
        renderMailbox();
        updateMoreButtonBadge();
      }
}

    moreTabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        setActiveTab(tab);
      });
    });

    function renderUpdateLog() {
      const entry = updateLogs[activeUpdateIndex];
      if (!entry) return;
      updateVersionTitle.textContent = entry.version;
      updateLinesList.innerHTML = '';
      entry.lines.forEach(line => {
        const li = document.createElement('li');
        li.textContent = line;
        updateLinesList.appendChild(li);
      });
      updateIndexLabel.textContent = `${activeUpdateIndex + 1} / ${updateLogs.length}`;
    }

    btnUpdatePrev.addEventListener('click', () => {
      activeUpdateIndex = (activeUpdateIndex - 1 + updateLogs.length) % updateLogs.length;
      renderUpdateLog();
    });
    btnUpdateNext.addEventListener('click', () => {
      activeUpdateIndex = (activeUpdateIndex + 1) % updateLogs.length;
      renderUpdateLog();
    });

        function openMoreModal(defaultTab = 'update', showDontShowButton = false) {
      try {
        moreModalBackdrop.classList.add('active');
        setActiveTab(defaultTab);
        renderUpdateLog();
        btnUpdateDontShow.style.display = showDontShowButton ? 'inline-block' : 'none';
      } catch (err) {
        console.error('[MoreModal] open failed:', err);
        try { showToast('ë”ë³´ê¸°ë¥¼ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)', 'warn'); } catch(e) {}
      }
    }


    function closeMoreModal() {
      moreModalBackdrop.classList.remove('active');
    }

        // v1.6.2: ë”ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì´ìŠˆ ë°©ì§€ (ê°€ë“œ + ì´ë²¤íŠ¸ ìœ„ì„)
    if (btnMore) btnMore.addEventListener('click', () => openMoreModal('update', false));
    document.addEventListener('click', (e) => {
      const t = e.target.closest && e.target.closest('#btnMore');
      if (t) openMoreModal('update', false);
    });
    if (btnMoreClose) btnMoreClose.addEventListener('click', closeMoreModal);
        if (btnMoreClose2) btnMoreClose2.addEventListener('click', closeMoreModal);
    moreModalBackdrop.addEventListener('click', (e) => {
      if (e.target === moreModalBackdrop) closeMoreModal();
    });

    function maybeShowUpdateOnStart() {
      const lastSeen = localStorage.getItem(LAST_SEEN_VERSION_KEY);
      if (lastSeen !== CURRENT_VERSION) {
        activeUpdateIndex = updateLogs.length - 1;
        renderUpdateLog();
        openMoreModal('update', true);
      }
    }

    btnUpdateDontShow.addEventListener('click', () => {
      localStorage.setItem(LAST_SEEN_VERSION_KEY, CURRENT_VERSION);
      closeMoreModal();
    });

    // ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
    function saveGame(silent = false) {
      state.lastSavedAt = Date.now();
      const saveData = {
        version: CURRENT_VERSION,
        savedAt: state.lastSavedAt,
        state: state,
        ownedCodes: ownedCodes,
        modifiers: modifiers
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
      localStorage.setItem(LAST_SEEN_VERSION_KEY, CURRENT_VERSION);

      if (!silent) {
        log('ê²Œì„ ìƒíƒœê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'system');
        showToast('ì €ì¥ ì™„ë£Œ', 'save');
      } else if (state.ui && state.ui.autoSaveToast) {
        showToast('âœ… ìë™ ì €ì¥ ì™„ë£Œ', 'save');
      }
      updateStatsUI();
    }

    function loadGame() {
      let raw = localStorage.getItem(SAVE_KEY);
      // ì €ì¥ ë°ì´í„° ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ (v16/v15 â†’ v17)
      if (!raw) {
        raw = localStorage.getItem(OLD_SAVE_KEY);
        if (raw) localStorage.setItem(SAVE_KEY, raw);
      }
      if (!raw) {
        raw = localStorage.getItem(LEGACY_SAVE_KEY);
        if (raw) localStorage.setItem(SAVE_KEY, raw);
      }
      if (!raw) {
        log('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'system');
        return;
      }
      try {
        const data = JSON.parse(raw);
        if (data.savedAt) state.lastSavedAt = data.savedAt;
        if (data.state) {
          Object.assign(state, state, data.state);
        }
        // Mailbox defaults
        ensureMailbox();
        // v1.7.x STAGE í€˜ìŠ¤íŠ¸ ë§ˆì´ê·¸ë ˆì´ì…˜
        state.missionProgress = state.missionProgress || {};
        state.missionProgress.stage = state.missionProgress.stage || { completed: {} };
        if (Array.isArray(data.ownedCodes)) {
          ownedCodes.length = 0;
          data.ownedCodes.forEach(c => ownedCodes.push(c));
        }
        if (data.modifiers) {
          Object.assign(modifiers, data.modifiers);
        }
        // ìƒˆ í•„ë“œ ê¸°ë³¸ê°’ ë³´ì •
        state.stats.energySpentTotal ||= 0;
        state.stats.creditsEarnedTotal ||= 0;
        state.stats.missionsCompletedTotal ||= 0;
        state.stats.riskHackSuccessCount ||= 0;
        // Trace Protocol í•„ë“œ ë³´ì •
        state.trace = (typeof state.trace === 'number') ? state.trace : 0;
        state.traceMax = state.traceMax || 100;
        state.traceLockMs = state.traceLockMs || 0;
        state.traceDecayAccMs = 0;
        state.missionProgress.general = state.missionProgress.general || { completed: {} };
        state.missionProgress.general.completed = state.missionProgress.general.completed || {};

        // v1.6.0 í•„ë“œ ë³´ì •
        state.items = state.items || { energyPack: 0 };
        state.items.energyPack = state.items.energyPack || 0;
        state.missionProgress.daily.actions = state.missionProgress.daily.actions || 0;

        // v1.6.1 UI ì„¤ì • ë³´ì •
        state.ui = state.ui || { shopSortMode: 'update' };
        state.ui.shopSortMode = state.ui.shopSortMode || 'update';

        // v1.6.5 UI ì„¤ì • ë³´ì •
        state.ui.toastDurationMs = state.ui.toastDurationMs || 3000;
        state.ui.uiZoom = state.ui.uiZoom || 1;
        state.ui.fontScale = state.ui.fontScale || 100;
        state.ui.anim = (typeof state.ui.anim === 'boolean') ? state.ui.anim : true;
        state.ui.autoSaveToast = !!state.ui.autoSaveToast;
        state.ui.logSearch = state.ui.logSearch || '';

        state.energy = Math.min(state.energy, state.energyMax);
        ensureMissionResets();
        applySettings();
        syncSettingsUI();
        updateStatsUI();
        updateServerMeta();
        refreshActionButtonsState();
        log('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'system');
      } catch (e) {
        console.error(e);
        log('ì €ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'system');
      }
    }

    function clearSave() {
      localStorage.removeItem(SAVE_KEY);
      log('ì €ì¥ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'system');
    }

    btnSaveGame.addEventListener('click', saveGame);
    btnLoadGame.addEventListener('click', loadGame);
    btnClearSave.addEventListener('click', clearSave);

    setInterval(() => {
      saveGame(true);
    }, 60000);

    // ë¡œê·¸ í•„í„°
    function bindLogFilterCheckbox(checkbox, key) {
      checkbox.addEventListener('change', () => {
        state.logFilter[key] = checkbox.checked;
        applyLogFilter();
      });
    }
    bindLogFilterCheckbox(filterSystem, 'system');
    bindLogFilterCheckbox(filterScan, 'scan');
    bindLogFilterCheckbox(filterHack, 'hack');
    bindLogFilterCheckbox(filterShop, 'shop');
    bindLogFilterCheckbox(filterLevel, 'level');

    // ë¡œê·¸ ì´ˆê¸°í™” / ìˆ¨ê¸°ê¸°
    btnClearLogs.addEventListener('click', () => {
      logList.innerHTML = '';
    });

    btnToggleLogs.addEventListener('click', () => {
      logsHidden = !logsHidden;
      logPanelBody.style.display = logsHidden ? 'none' : '';
      btnToggleLogs.textContent = logsHidden ? 'ë¡œê·¸ ë³´ì´ê¸°' : 'ë¡œê·¸ ìˆ¨ê¸°ê¸°';
    });

    // ë¯¸ì…˜ ìŠ¤ì½”í”„ ë²„íŠ¼
    missionScopeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        missionScopeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        missionScopeActive = btn.dataset.scope;
        renderMissions();
      });
    });

    // ê¸°íƒ€ ë²„íŠ¼

    // ìƒì  ì •ë ¬
    if (shopSortSelect) {
      shopSortSelect.value = (state.ui && state.ui.shopSortMode) ? state.ui.shopSortMode : 'update';
      shopSortSelect.addEventListener('change', () => {
        state.ui = state.ui || { shopSortMode: 'update' };
        state.ui.shopSortMode = shopSortSelect.value;
        renderShop();
      });
    }

    // ì„¤ì • ì ìš©
    function applySettings() {
      const ui = state.ui || {};
      const fontScale = Number(ui.fontScale || 100);
      const zoom = Number(ui.uiZoom || 1);
      document.documentElement.style.setProperty('--font-scale', String(fontScale / 100));
      document.documentElement.style.setProperty('--ui-zoom', String(zoom));
      document.body.classList.toggle('no-anim', ui.anim === false);
    }

    function syncSettingsUI() {
      if (!setFontScale) return;
      const ui = state.ui || {};
      setFontScale.value = ui.fontScale || 100;
      setFontScaleLabel.textContent = `${setFontScale.value}%`;
      setUiZoom.value = String(ui.uiZoom || 1);
      setAnim.checked = ui.anim !== false;
      setToastMs.value = String(ui.toastDurationMs || 3000);
      setAutoSaveToast.checked = !!ui.autoSaveToast;
      if (logSearchInput) logSearchInput.value = ui.logSearch || '';
    }

    if (setFontScale) {
      setFontScale.addEventListener('input', () => {
        state.ui.fontScale = Number(setFontScale.value);
        setFontScaleLabel.textContent = `${setFontScale.value}%`;
        applySettings();
        saveGame(true);
      });
    }
    if (setUiZoom) {
      setUiZoom.addEventListener('change', () => {
        state.ui.uiZoom = Number(setUiZoom.value);
        applySettings();
        saveGame(true);
      });
    }
    if (setAnim) {
      setAnim.addEventListener('change', () => {
        state.ui.anim = !!setAnim.checked;
        applySettings();
        saveGame(true);
      });
    }
    if (setToastMs) {
      setToastMs.addEventListener('change', () => {
        state.ui.toastDurationMs = Number(setToastMs.value);
        saveGame(true);
      });
    }
    if (setAutoSaveToast) {
      setAutoSaveToast.addEventListener('change', () => {
        state.ui.autoSaveToast = !!setAutoSaveToast.checked;
        saveGame(true);
      });
    }

    // ë¡œê·¸ ê²€ìƒ‰ + í•€
    if (logSearchInput) {
      logSearchInput.addEventListener('input', () => {
        state.ui.logSearch = logSearchInput.value || '';
        applyLogFilter();
        saveGame(true);
      });
    }
    if (logList) {
      logList.addEventListener('click', (e) => {
        const entry = e.target.closest('.log-entry');
        if (!entry) return;
        const pinned = entry.dataset.pinned === '1';
        entry.dataset.pinned = pinned ? '0' : '1';
        entry.classList.toggle('pinned', !pinned);
        if (!pinned) logList.prepend(entry);
      });
    }

    // ë‚´ë³´ë‚´ê¸° / ë¶ˆëŸ¬ì˜¤ê¸°
    function exportSaveFile() {
      try {
        const raw = localStorage.getItem(SAVE_KEY);
        const data = raw ? raw : JSON.stringify({ version: CURRENT_VERSION, state, ownedCodes, modifiers });
        const blob = new Blob([data], { type: 'application/json;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        a.download = `HCSiG_save_${yyyy}${mm}${dd}_${CURRENT_VERSION}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
        showToast('ì €ì¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ', 'save');
      } catch (e) {
        console.error(e);
        showToast('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)', 'warn');
      }
    }

    function importSaveFromText(text) {
      try {
        const obj = JSON.parse(text);
        localStorage.setItem(SAVE_KEY, JSON.stringify(obj));
        loadGame();
        showToast('ì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ', 'save');
      } catch (e) {
        console.error(e);
        showToast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: JSON í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.', 'warn');
      }
    }

    if (btnExportSave) btnExportSave.addEventListener('click', exportSaveFile);

    if (btnImportSaveFile && fileImportSave) {
      btnImportSaveFile.addEventListener('click', () => fileImportSave.click());
      fileImportSave.addEventListener('change', async () => {
        const f = fileImportSave.files && fileImportSave.files[0];
        if (!f) return;
        const text = await f.text();
        importSaveFromText(text);
        fileImportSave.value = '';
      });
    }

    if (btnImportSaveText && importSaveText) {
      btnImportSaveText.addEventListener('click', () => {
        const text = (importSaveText.value || '').trim();
        if (!text) {
          showToast('í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.', 'warn');
          return;
        }
        importSaveFromText(text);
      });
    }

    btnScan.addEventListener('click', scanForCode);
    btnHack.addEventListener('click', doHack);
    btnUpgradeCpu.addEventListener('click', upgradeCpu);
    btnUpgradeCode.addEventListener('click', upgradeSelectedCode);
    btnEvolveCode.addEventListener('click', evolveSelectedCode);

    btnUseEnergyPack.addEventListener('click', useEnergyPack);

    chkRiskMode.addEventListener('change', () => {
      state.riskMode = chkRiskMode.checked;
      log(`ìœ„í—˜ í•´í‚¹ ëª¨ë“œ: ${state.riskMode ? 'ON' : 'OFF'}`, 'system');
    });

    serverSelect.addEventListener('change', () => {
      updateServerMeta();
    });

    btnSaveLoadout.addEventListener('click', saveCurrentLoadout);
    btnLoadLoadout.addEventListener('click', loadLoadout);

    function init() {
      addCodeInstanceFromTemplate('basic');
      state.requiredExp = requiredExp(state.level);
      renderServers();
      renderShop();
      ensureMissionResets();
      applySettings();
      syncSettingsUI();
      updateStatsUI();
      updateServerMeta();
      refreshActionButtonsState();
      log('HCSiG ì´ˆê¸°í™” ì™„ë£Œ. (v1.7 Trace Protocol)', 'system');

      if (localStorage.getItem(SAVE_KEY)) {
        loadGame();
      } else {
        updateStatsUI();
      }

      // seasonal + mailbox
      ensureChristmasMails();
      setupSnow();
      updateMoreButtonBadge();

      const btnClaimAllMail = document.getElementById('btnClaimAllMail');
      if (btnClaimAllMail) {
        btnClaimAllMail.addEventListener('click', () => {
          claimAllMail();
          renderMailbox();
        });
      }

      window.addEventListener('resize', () => {
        setupSnow();
      });

      renderUpdateLog();
      maybeShowUpdateOnStart();
    }

    init();
  

// === MOBILE VIEWS: split PC layout into mobile tabs ===
(function(){
  const isMobile = window.matchMedia('(max-width: 900px), (hover: none) and (pointer: coarse)').matches;
  if(!isMobile) return;

  // helper
  const byText = (root, sel, txt) => {
    const els = Array.from(root.querySelectorAll(sel));
    return els.find(e => (e.textContent||'').trim().toLowerCase() === txt.toLowerCase());
  };

  // Create mobile view containers
  const views = [
    ['Status','mobileViewStatus'],
    ['Action','mobileViewAction'],
    ['Codes','mobileViewCodes'],
    ['Shop','mobileViewShop'],
    ['Log','mobileViewLog'],
  ];
  const main = document.getElementById('main') || document.querySelector('#main') || document.body;

  views.forEach(([_,id])=>{
    if(document.getElementById(id)) return;
    const v = document.createElement('div');
    v.id = id;
    v.className = 'mobile-view';
    main.insertBefore(v, main.firstChild);
  });

  // Move leftPanel -> Status + Shop
  const left = document.getElementById('leftPanel');
  if(left){
    const shopTitle = Array.from(left.querySelectorAll('.section-title')).find(t => (t.textContent||'').trim()==='Shop');
    const statusView = document.getElementById('mobileViewStatus');
    const shopView = document.getElementById('mobileViewShop');

    if(shopTitle){
      // nodes before Shop go to Status
      let node = left.firstChild;
      const toMoveStatus = [];
      while(node && node !== shopTitle){
        const next = node.nextSibling;
        toMoveStatus.push(node);
        node = next;
      }
      toMoveStatus.forEach(n=>statusView.appendChild(n));

      // Shop title and everything after -> Shop
      let node2 = shopTitle;
      const toMoveShop = [];
      while(node2){
        const next = node2.nextSibling;
        toMoveShop.push(node2);
        node2 = next;
      }
      toMoveShop.forEach(n=>shopView.appendChild(n));
    }else{
      // fallback: whole left panel in Status
      statusView.appendChild(left);
    }
  }

  // Move centerPanel -> Action + Codes
  const center = document.getElementById('centerPanel');
  if(center){
    const actionView = document.getElementById('mobileViewAction');
    const codesView  = document.getElementById('mobileViewCodes');

    const codeInvTitle = Array.from(center.querySelectorAll('.section-title')).find(t => (t.textContent||'').trim()==='ì½”ë“œ ì¸ë²¤í† ë¦¬');
    let codeBlock = null;
    if(codeInvTitle){
      // typically inside a flex-row container
      codeBlock = codeInvTitle.closest('.flex-row') || codeInvTitle.closest('.stat-box') || codeInvTitle.parentElement;
    }

    if(codeBlock){
      // move nodes before codeBlock into Action
      let node = center.firstChild;
      const toMoveAction = [];
      while(node && node !== codeBlock){
        const next = node.nextSibling;
        toMoveAction.push(node);
        node = next;
      }
      toMoveAction.forEach(n=>actionView.appendChild(n));

      // move codeBlock and after into Codes
      let node2 = codeBlock;
      const toMoveCodes = [];
      while(node2){
        const next = node2.nextSibling;
        toMoveCodes.push(node2);
        node2 = next;
      }
      toMoveCodes.forEach(n=>codesView.appendChild(n));
    }else{
      // fallback: whole center in Action
      actionView.appendChild(center);
    }
  }

  // LOG view: try to use existing logBox if present, else open "ë”ë³´ê¸°" logs
  const logView = document.getElementById('mobileViewLog');
  const logBox = document.getElementById('logBox');
  if(logBox){
    logView.appendChild(logBox.closest('.stat-box') ? logBox.closest('.stat-box') : logBox);
  } else {
    const tip = document.createElement('div');
    tip.className = 'stat-box';
    tip.innerHTML = '<div class="section-title">Log</div><div class="small">LOGëŠ” ìƒë‹¨ì˜ â€œë”ë³´ê¸°â€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
    logView.appendChild(tip);
  }

  // Replace tab bar with 5 tabs
  const oldTabs = document.querySelector('.mobile-tabs');
  if(oldTabs) oldTabs.remove();

  const wrap = document.createElement('div');
  wrap.className = 'mobile-tabs';
  wrap.innerHTML = `
    <button type="button" data-view="status">STATUS</button>
    <button type="button" data-view="action">ACTION</button>
    <button type="button" data-view="codes">CODES</button>
    <button type="button" data-view="shop">SHOP</button>
    <button type="button" data-view="log">LOG</button>
  `;
  document.body.appendChild(wrap);

  function setView(v){
    document.body.classList.remove('mobile-view-status','mobile-view-action','mobile-view-codes','mobile-view-shop','mobile-view-log');
    document.body.classList.add('mobile-view-'+v);
    wrap.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b.dataset.view===v));
    const id = 'mobileView' + v.charAt(0).toUpperCase() + v.slice(1);
    const panel = document.getElementById(id);
    if(panel) panel.scrollTop = 0;

    // If LOG chosen and logs are in more modal, try open it
    if(v==='log'){
      const btnMore = document.getElementById('btnMore');
      if(btnMore && !document.getElementById('logBox')) btnMore.click();
    }
  }

  wrap.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>setView(btn.dataset.view));
  });

  // When a code is tapped, auto-scroll to detail inside codes view
  const codeList = document.getElementById('codeList');
  const codeDetail = document.getElementById('codeDetail');
  if(codeList && codeDetail){
    codeList.addEventListener('click', (e)=>{
      const li = e.target.closest('li');
      if(!li) return;
      // ensure we're on Codes view
      setView('codes');
      setTimeout(()=>codeDetail.scrollIntoView({behavior:'smooth', block:'start'}), 50);
    });
  }

  // default view
  setView('status');
})()

</script>

<script>
(function () {
  function setAppHeight() {
    document.documentElement.style.setProperty('--app-height', window.innerHeight + 'px');
  }
  window.addEventListener('resize', setAppHeight);
  window.addEventListener('orientationchange', setAppHeight);
  setAppHeight();
})();
</script>

</body>
</html>
